{% extends "base.html" %}

{% block title %}Roll-up | Marketing Intelligence{% endblock %}

{% block content %}
<div class="page-header mb-3">
  <div class="row align-items-center">
    <div class="col">
      <h2 class="page-title">All Clients</h2>
      <div class="text-muted">Aggregate KPIs across selected clients.</div>
    </div>
    <div class="col-auto">
      <a href="/features/marketing-intelligence/ga4" class="btn btn-outline-secondary">
        <i class="ti ti-arrow-left me-1"></i> Back to clients
      </a>
    </div>
  </div>
</div>

<div class="row row-cards mb-3">
  <div class="col-md-8">
    <div class="card">
      <div class="card-body">
        <div class="mb-2 fw-semibold">Select connections</div>
        <div class="d-flex flex-wrap gap-2">
          {% for conn in connections %}
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" value="{{ conn.id }}" onchange="toggleRollup(this)" checked>
              <span class="form-check-label">
                {{ conn.client_name or conn.property_name or 'GA4 Property' }} ({{ conn.property_id }})
              </span>
            </label>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4 text-md-end text-muted small">
    Last synced varies by connection
  </div>
</div>

<div class="row row-cards">
  <div class="col-sm-6 col-md-3">
    <stats-card id="rollup-kpi-sessions" title="Sessions" icon="ti-users" color="blue" loading></stats-card>
  </div>
  <div class="col-sm-6 col-md-3">
    <stats-card id="rollup-kpi-users" title="Users" icon="ti-user-plus" color="green" loading></stats-card>
  </div>
  <div class="col-sm-6 col-md-3">
    <stats-card id="rollup-kpi-conv" title="Conversions" icon="ti-target" color="orange" loading></stats-card>
  </div>
  <div class="col-sm-6 col-md-3">
    <stats-card id="rollup-kpi-cr" title="Conversion Rate" icon="ti-activity" color="purple" loading></stats-card>
  </div>
</div>

<div class="row row-cards mt-3">
  <div class="col-md-6">
    <chart-widget
      id="rollup-chart-traffic"
      type="line"
      title="Traffic (Sessions vs Users)"
      description="Aggregate across selected"
      height="260"
    ></chart-widget>
  </div>
  <div class="col-md-6">
    <chart-widget
      id="rollup-chart-conv"
      type="line"
      title="Conversions"
      description="Aggregate across selected"
      height="260"
    ></chart-widget>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="/dashboard/static/js/stats-card.js?v=tabler"></script>
<script src="/dashboard/static/js/chart-widget.js?v=tabler"></script>
<script>
  const GA4_MS_DAY = 24 * 60 * 60 * 1000;
  function formatDate(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function selectedIds() {
    return Array.from(document.querySelectorAll('input[type=checkbox][onchange="toggleRollup(this)"]:checked')).map(c => c.value);
  }
  function refreshRollup() {
    const ids = selectedIds();
    if (ids.length === 0) return;
    const end = new Date();
    const start = new Date(end.getTime() - 29 * GA4_MS_DAY);
    const kpiUrl = `/features/marketing-intelligence/ga4/metrics/rollup/kpis?connection_ids=${ids.join(',')}&start_date=${formatDate(start)}&end_date=${formatDate(end)}`;
    document.querySelector('#rollup-kpi-sessions').setAttribute('data-url', kpiUrl + '&data_key=sessions');
    document.querySelector('#rollup-kpi-users').setAttribute('data-url', kpiUrl + '&data_key=users');
    document.querySelector('#rollup-kpi-conv').setAttribute('data-url', kpiUrl + '&data_key=conversions');
    document.querySelector('#rollup-kpi-cr').setAttribute('data-url', kpiUrl + '&data_key=conversion_rate');
    document.querySelectorAll('stats-card').forEach(c => { if (typeof c.refresh === 'function') c.refresh(); });

    const trafficChart = document.getElementById('rollup-chart-traffic');
    trafficChart.setAttribute('data-url', `/features/marketing-intelligence/ga4/metrics/rollup/timeseries_chart?connection_ids=${ids.join(',')}&start_date=${formatDate(start)}&end_date=${formatDate(end)}&metrics=sessions,users`);
    if (typeof trafficChart.loadData === 'function') trafficChart.loadData();
    const convChart = document.getElementById('rollup-chart-conv');
    convChart.setAttribute('data-url', `/features/marketing-intelligence/ga4/metrics/rollup/timeseries_chart?connection_ids=${ids.join(',')}&start_date=${formatDate(start)}&end_date=${formatDate(end)}&metrics=conversions`);
    if (typeof convChart.loadData === 'function') convChart.loadData();
  }
  function toggleRollup() { refreshRollup(); }
  document.addEventListener('DOMContentLoaded', () => refreshRollup());
</script>
{% endblock %}
