{% extends "base.html" %}

{% block title %}Automation Templates{% endblock %}

{% block head %}
<style>
    .template-card {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .template-card:hover {
        border-color: #0066cc;
        box-shadow: 0 4px 12px rgba(0, 102, 204, 0.15);
        transform: translateY(-2px);
    }

    .template-card.selected {
        border-color: #0066cc;
        background-color: #f8f9ff;
    }

    .template-icon {
        font-size: 3rem;
        color: #0066cc;
        margin-bottom: 1rem;
    }

    .provider-choice {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 1rem;
        background: #f8f9fa;
    }

    .provider-option {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 6px;
        margin: 0.25rem 0;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .provider-option:hover {
        background-color: #e9ecef;
    }

    .provider-option input[type="radio"] {
        margin-right: 0.75rem;
    }

    .provider-logo {
        width: 20px;
        height: 20px;
        margin-right: 0.5rem;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
    }

    .provider-logo.openai { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="%23000" viewBox="0 0 24 24"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0z"/></svg>'); }
    .provider-logo.anthropic { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="%23D2691E" viewBox="0 0 24 24"><circle cx="12" cy="12" r="12"/></svg>'); }
    .provider-logo.gmail { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="%23EA4335" viewBox="0 0 24 24"><path d="M24 5.457v13.086c0 .702-.57 1.272-1.272 1.272H1.272C.57 19.815 0 19.245 0 18.543V5.457c0-.702.57-1.272 1.272-1.272h21.456c.702 0 1.272.57 1.272 1.272z"/></svg>'); }
    .provider-logo.slack { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="%234A154B" viewBox="0 0 24 24"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.528 2.528 0 0 1 2.522-2.523h2.52v2.523z"/></svg>'); }

    .automation-preview {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin: 2rem 0;
    }

    .setup-step {
        opacity: 0.7;
        transition: opacity 0.3s;
    }

    .setup-step.active {
        opacity: 1;
    }

    .category-tabs {
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 2rem;
    }

    .category-tab {
        padding: 1rem 1.5rem;
        border: none;
        background: none;
        color: #6c757d;
        font-weight: 500;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
    }

    .category-tab.active {
        color: #0066cc;
        border-bottom-color: #0066cc;
    }

    .category-tab:hover {
        color: #0066cc;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">üöÄ Automation Templates</h1>
            <p class="text-muted">Choose an automation template and configure your providers</p>
        </div>
        <div>
            <a href="/features/business-automations/instances" class="btn btn-outline-primary">
                <i class="ti ti-list"></i> My Automations
            </a>
        </div>
    </div>

    <!-- Category Tabs -->
    <div class="category-tabs">
        <button class="category-tab active" data-category="all">All Templates</button>
        <button class="category-tab" data-category="communication">üìß Communication</button>
        <button class="category-tab" data-category="notifications">üîî Notifications</button>
        <button class="category-tab" data-category="content">‚úçÔ∏è Content</button>
        <button class="category-tab" data-category="data">üìä Data & Analytics</button>
    </div>

    <div id="setup-wizard" style="display: none;">
        <!-- Step 1: Template Selection -->
        <div class="setup-step active" id="step-template">
            <div class="row">
                <div class="col-md-8">
                    <h4 class="mb-4">üìã Step 1: Choose Your Automation</h4>
                    <div class="row" id="template-grid">
                        <!-- Templates will be populated here -->
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="automation-preview" id="template-preview" style="display: none;">
                        <h5 class="mb-3">üîç Preview</h5>
                        <div id="preview-content">
                            <!-- Preview content here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Provider Configuration -->
        <div class="setup-step" id="step-providers" style="display: none;">
            <h4 class="mb-4">üîß Step 2: Configure Providers</h4>
            <div class="row">
                <div class="col-md-8">
                    <form id="provider-form">
                        <div id="provider-choices">
                            <!-- Provider choices will be populated here -->
                        </div>
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary" onclick="goToStep(1)">
                                <i class="ti ti-arrow-left"></i> Back
                            </button>
                            <button type="button" class="btn btn-primary" onclick="goToStep(3)">
                                Next: Configure <i class="ti ti-arrow-right"></i>
                            </button>
                        </div>
                    </form>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">üîê Provider Authentication</h6>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small">
                                Your provider credentials are securely managed through our
                                <a href="/features/connectors/connectors" target="_blank">connector system</a>.
                                Missing credentials will be detected automatically.
                            </p>
                            <div id="credential-status">
                                <!-- Credential status will show here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Automation Configuration -->
        <div class="setup-step" id="step-config" style="display: none;">
            <h4 class="mb-4">‚öôÔ∏è Step 3: Automation Settings</h4>
            <div class="row">
                <div class="col-md-8">
                    <form id="automation-form">
                        <div id="automation-config">
                            <!-- Automation configuration form will be populated here -->
                        </div>
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary" onclick="goToStep(2)">
                                <i class="ti ti-arrow-left"></i> Back
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="ti ti-rocket"></i> Create Automation
                            </button>
                        </div>
                    </form>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">üìã Summary</h6>
                        </div>
                        <div class="card-body">
                            <div id="automation-summary">
                                <!-- Summary will show here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Initial Templates Grid -->
    <div id="templates-overview">
        <div class="row">
            <!-- Email + AI Response -->
            <div class="col-md-6 col-lg-4 mb-4" data-category="communication">
                <div class="card template-card h-100" data-template="email_ai_response">
                    <div class="card-body text-center">
                        <i class="ti ti-mail-ai template-icon"></i>
                        <h5 class="card-title">üìß Email + AI Response</h5>
                        <p class="card-text text-muted">
                            Automatically respond to emails using AI.
                            <br><small>Choose: Gmail/M365 + OpenAI/Claude/Gemini</small>
                        </p>
                        <div class="mt-3">
                            <span class="badge bg-light text-dark me-2">Gmail</span>
                            <span class="badge bg-light text-dark me-2">M365</span>
                            <span class="badge bg-primary me-2">OpenAI</span>
                            <span class="badge bg-warning me-2">Claude</span>
                            <span class="badge bg-info">Gemini</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Team Notifications -->
            <div class="col-md-6 col-lg-4 mb-4" data-category="notifications">
                <div class="card template-card h-100" data-template="team_notifications">
                    <div class="card-body text-center">
                        <i class="ti ti-bell-ringing template-icon"></i>
                        <h5 class="card-title">üîî Smart Team Notifications</h5>
                        <p class="card-text text-muted">
                            Send intelligent notifications to your team.
                            <br><small>Choose: Slack/Teams + Optional AI formatting</small>
                        </p>
                        <div class="mt-3">
                            <span class="badge bg-light text-dark me-2">Slack</span>
                            <span class="badge bg-light text-dark me-2">Teams</span>
                            <span class="badge bg-secondary">+ AI Format</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Generation -->
            <div class="col-md-6 col-lg-4 mb-4" data-category="content">
                <div class="card template-card h-100" data-template="content_generation">
                    <div class="card-body text-center">
                        <i class="ti ti-article template-icon"></i>
                        <h5 class="card-title">‚úçÔ∏è Multi-Model Content</h5>
                        <p class="card-text text-muted">
                            Generate content with multiple AI providers.
                            <br><small>Primary + Fallback + Review AI options</small>
                        </p>
                        <div class="mt-3">
                            <span class="badge bg-primary me-2">OpenAI</span>
                            <span class="badge bg-warning me-2">Claude</span>
                            <span class="badge bg-info me-2">Gemini</span>
                            <span class="badge bg-success">Multi-AI</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Web Data + AI -->
            <div class="col-md-6 col-lg-4 mb-4" data-category="data">
                <div class="card template-card h-100" data-template="data_extraction_analysis">
                    <div class="card-body text-center">
                        <i class="ti ti-world-search template-icon"></i>
                        <h5 class="card-title">üåê Web Data + AI Analysis</h5>
                        <p class="card-text text-muted">
                            Extract data from websites and analyze with AI.
                            <br><small>Firecrawl + AI Analysis + Storage options</small>
                        </p>
                        <div class="mt-3">
                            <span class="badge bg-light text-dark me-2">Firecrawl</span>
                            <span class="badge bg-primary me-2">AI Analysis</span>
                            <span class="badge bg-secondary">Storage</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Custom Template -->
            <div class="col-md-6 col-lg-4 mb-4" data-category="all">
                <div class="card template-card h-100 border-dashed" style="border-style: dashed !important;">
                    <div class="card-body text-center d-flex flex-column justify-content-center">
                        <i class="ti ti-plus-circle template-icon text-muted"></i>
                        <h5 class="card-title text-muted">Custom Automation</h5>
                        <p class="card-text text-muted">
                            Build your own automation from scratch using our connector library.
                        </p>
                        <button class="btn btn-outline-primary btn-sm mt-2">
                            <i class="ti ti-tool"></i> Build Custom
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
let selectedTemplate = null;
let selectedProviders = {};

// Template data (would come from backend)
const templates = {
    email_ai_response: {
        name: "Email + AI Response",
        description: "Automatically respond to emails using AI",
        providers: {
            email: {
                title: "Email Provider",
                required: true,
                options: [
                    { value: "gmail", label: "Gmail", logo: "gmail" },
                    { value: "microsoft365", label: "Microsoft 365", logo: "microsoft365" }
                ]
            },
            ai: {
                title: "AI Provider",
                required: true,
                options: [
                    { value: "openai", label: "OpenAI GPT", logo: "openai" },
                    { value: "anthropic", label: "Claude (Anthropic)", logo: "anthropic" },
                    { value: "gemini", label: "Google Gemini", logo: "gemini" }
                ]
            }
        },
        config: [
            { name: "response_tone", type: "select", label: "Response Tone", options: ["professional", "friendly", "casual"], default: "professional" },
            { name: "auto_send", type: "checkbox", label: "Auto-send responses", default: false },
            { name: "response_delay_minutes", type: "number", label: "Response delay (minutes)", default: 5, min: 0, max: 60 }
        ]
    }
    // ... other templates
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
});

function setupEventListeners() {
    // Category tabs
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            filterByCategory(this.dataset.category);
            document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Template cards
    document.querySelectorAll('.template-card').forEach(card => {
        card.addEventListener('click', function() {
            if (!this.classList.contains('border-dashed')) {
                selectTemplate(this.dataset.template);
            }
        });
    });
}

function filterByCategory(category) {
    const cards = document.querySelectorAll('[data-category]');
    cards.forEach(card => {
        if (category === 'all' || card.dataset.category === category) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

function selectTemplate(templateId) {
    selectedTemplate = templateId;

    // Hide overview, show wizard
    document.getElementById('templates-overview').style.display = 'none';
    document.getElementById('setup-wizard').style.display = 'block';

    // Load template data and show providers step
    loadProviderChoices(templateId);
    goToStep(2);
}

function loadProviderChoices(templateId) {
    const template = templates[templateId];
    if (!template) return;

    const providerChoices = document.getElementById('provider-choices');
    providerChoices.innerHTML = '';

    Object.entries(template.providers).forEach(([providerType, config]) => {
        const choiceDiv = document.createElement('div');
        choiceDiv.className = 'provider-choice';
        choiceDiv.innerHTML = `
            <h6>${config.title} ${config.required ? '<span class="text-danger">*</span>' : ''}</h6>
            <div class="provider-options">
                ${config.options.map(option => `
                    <label class="provider-option">
                        <input type="radio" name="${providerType}" value="${option.value}" ${config.required ? 'required' : ''}>
                        <div class="provider-logo ${option.logo}"></div>
                        ${option.label}
                    </label>
                `).join('')}
            </div>
        `;
        providerChoices.appendChild(choiceDiv);
    });
}

function goToStep(step) {
    // Hide all steps
    document.querySelectorAll('.setup-step').forEach(s => {
        s.style.display = 'none';
        s.classList.remove('active');
    });

    // Show target step
    const stepElement = document.getElementById(`step-${['', 'template', 'providers', 'config'][step]}`);
    if (stepElement) {
        stepElement.style.display = 'block';
        stepElement.classList.add('active');
    }

    currentStep = step;
}

function createAutomation() {
    // Collect form data and submit
    const formData = new FormData(document.getElementById('automation-form'));
    const providers = new FormData(document.getElementById('provider-form'));

    // Combine data and submit to backend
    console.log('Creating automation with:', {
        template: selectedTemplate,
        providers: Object.fromEntries(providers.entries()),
        config: Object.fromEntries(formData.entries())
    });

    // Show success and redirect
    showToast('Automation created successfully!', 'success');
    setTimeout(() => {
        window.location.href = '/features/business-automations/instances';
    }, 1500);
}

function showToast(message, type = 'info') {
    // Toast implementation
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'info'} position-fixed`;
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}
