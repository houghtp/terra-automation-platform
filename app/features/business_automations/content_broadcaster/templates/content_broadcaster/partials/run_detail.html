{% set selected = selected_run %}
{% set selected_content = content %}

{% if not selected_content %}
<div class="empty">
    <div class="empty-icon">
        <i class="ti ti-file-text icon-lg text-muted"></i>
    </div>
    <p class="empty-title">No content available for this run</p>
    <p class="empty-subtitle text-muted">Generate a new version or select another run to preview its details.</p>
</div>
{% else %}
{% set seo_score = selected.seo_score if selected else plan.latest_seo_score %}
{% if seo_score %}
<div class="alert alert-{{ 'success' if seo_score >= 95 else 'warning' if seo_score >= 80 else 'danger' }} mb-4">
    <div class="d-flex align-items-center">
        <div class="flex-grow-1">
            <h4 class="alert-title mb-1">
                <i class="ti ti-chart-line me-2"></i>
                SEO Score: {{ seo_score }}/100
            </h4>
            <p class="mb-0">
                {% if seo_score >= 95 %}
                <i class="ti ti-check-circle me-1"></i>Excellent! Content meets SEO quality standards.
                {% elif seo_score >= 80 %}
                <i class="ti ti-alert-circle me-1"></i>Good content, but could be refined further.
                {% else %}
                <i class="ti ti-alert-triangle me-1"></i>Content needs improvement to meet quality standards.
                {% endif %}
            </p>
        </div>
        {# <div class="ms-auto">
            <span
                class="status-badge status-{{ 'success' if seo_score >= 95 else 'warning' if seo_score >= 80 else 'danger' }} text-normal">
                {{ seo_score }}
            </span>
        </div> #}
    </div>
</div>
{% endif %}

{% if selected and selected.sub_scores %}
{% set score_labels = {
'keyword_coverage': 'Keyword Coverage',
'structure': 'Structure',
'readability': 'Readability',
'engagement': 'Engagement',
'technical': 'Technical'
} %}
{% set score_hints = {
'keyword_coverage': 'Target keyword density and variety',
'structure': 'Heading hierarchy, FAQs, CTA placement',
'readability': 'Clarity, tone, and audience alignment',
'engagement': 'Hooks, storytelling, multimedia opportunities',
'technical': 'Links, schema, metadata, page experience'
} %}
{% set score_details = selected.sub_score_details if selected and selected.sub_score_details else {} %}
{% set validator_metadata = selected.validation_metadata if selected and selected.validation_metadata else {} %}
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title mb-0"><i class="ti ti-gauge me-2"></i>SEO Breakdown</h3>
    </div>
    <div class="card-body">
        <div class="row g-3">
            {% for key, value in selected.sub_scores.items() %}
            <div class="col-md-6 col-lg-4">
                <div class="text-muted small">{{ score_labels.get(key, (key|replace('_', ' ')|title)) }}</div>
                <div class="d-flex align-items-baseline">
                    <div class="h3 mb-0 me-3">{{ value }}/100</div>
                    {% set detail_text = score_details.get(key) or score_hints.get(key, '') %}
                    <div class="text-muted small mb-0 flex-grow-1">{{ detail_text }}</div>
                </div>
                <div class="progress mt-2" style="height: 6px;">
                    <div class="progress-bar bg-{{ 'success' if value >= 85 else 'warning' if value >= 65 else 'danger' }}"
                        role="progressbar" style="width: {{ value }}%;"></div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% if validator_metadata %}
        <hr class="my-4">
        <div class="row g-3">
            <div class="col-md-3">
                <div class="text-muted small">Validator Word Count</div>
                <div class="h4 mb-0">{{ validator_metadata.word_count or 'â€”' }}</div>
            </div>
            <div class="col-md-3">
                <div class="text-muted small">Reading Level</div>
                <div class="h4 mb-0">{{ validator_metadata.reading_level or 'Unknown' }}</div>
            </div>
            <div class="col-md-3">
                <div class="text-muted small">Tone Alignment</div>
                <p class="mb-0 text-muted small">{{ validator_metadata.tone_alignment or 'Not provided' }}</p>
            </div>
            <div class="col-md-3">
                <div class="text-muted small">Target Score</div>
                <div class="h4 mb-0">{{ selected.target_score or plan.min_seo_score }}</div>
            </div>
            {% if validator_metadata.primary_keywords_used %}
            <div class="col-md-6">
                <div class="text-muted small">Primary Keywords Used</div>
                <div class="d-flex flex-wrap gap-2 mt-1">
                    {% for keyword in validator_metadata.primary_keywords_used %}
                    <span class="status-badge status-info text-normal">{{ keyword }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% if validator_metadata.secondary_keywords_used %}
            <div class="col-md-6">
                <div class="text-muted small">Secondary Keywords Used</div>
                <div class="d-flex flex-wrap gap-2 mt-1">
                    {% for keyword in validator_metadata.secondary_keywords_used %}
                    <span class="status-badge status-neutral text-normal">{{ keyword }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% if validator_metadata.schema_opportunities or validator_metadata.link_opportunities %}
        <div class="row g-3 mt-2">
            {% if validator_metadata.schema_opportunities %}
            <div class="col-md-6">
                <div class="alert alert-info mb-0">
                    <strong class="d-block mb-1"><i class="ti ti-code-plus me-1"></i>Schema</strong>
                    <span>{{ validator_metadata.schema_opportunities }}</span>
                </div>
            </div>
            {% endif %}
            {% if validator_metadata.link_opportunities %}
            <div class="col-md-6">
                <div class="alert alert-info mb-0">
                    <strong class="d-block mb-1"><i class="ti ti-link me-1"></i>Linking</strong>
                    <span>{{ validator_metadata.link_opportunities }}</span>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% endif %}
    </div>
</div>
{% endif %}

{% set word_count = selected_content.body.split()|length if selected_content.body else 0 %}
{% set reading_time = (word_count / 200)|round|int %}
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="text-muted small">Word Count</div>
                <div class="h3 mb-0">{{ word_count }}</div>
            </div>
            <div class="col-md-3">
                <div class="text-muted small">Reading Time</div>
                <div class="h3 mb-0">{{ reading_time if reading_time > 0 else 1 }} min</div>
            </div>
            <div class="col-md-3">
                <div class="text-muted small">Iterations</div>
                <div class="h3 mb-0">{{ selected.iterations if selected else plan.current_iteration }} / {{
                    plan.max_iterations }}</div>
            </div>
            <div class="col-md-3">
                <div class="text-muted small">Run Status</div>
                <div class="h3 mb-0">
                    <span
                        class="status-badge status-{{ 'success' if (selected and selected.status == 'published') else 'info' }}">
                        {{ selected.status.replace('_', ' ').title() if selected and selected.status else
                        plan.status.replace('_', ' ').title() }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h3 class="card-title mb-0">
            <i class="ti ti-file-text me-2"></i>
            {{ selected_content.title }}
        </h3>
        <div class="d-flex align-items-center gap-2">
            {% if selected and selected.human_edited %}
            <span class="status-badge status-warning text-normal">
                <i class="ti ti-user-edit me-1"></i>
                Edited {{ selected.edited_by or 'Human Editor' }}
            </span>
            {% endif %}
            {% if selected_run_id %}
            <button type="button"
                    class="btn btn-outline-primary btn-sm"
                    onclick="editRunContent('{{ plan.id }}', '{{ selected_run_id }}')">
                <i class="ti ti-edit me-1"></i>
                Edit Content
            </button>
            <button
                class="btn btn-outline-secondary btn-sm"
                hx-post="/features/content-broadcaster/planning/{{ plan.id }}/runs/{{ selected_run_id }}/validate"
                hx-target="#plan-detail-container"
                hx-swap="innerHTML"
                hx-disabled-elt="this">
                <i class="ti ti-reload me-1"></i>
                Re-run SEO Analysis
            </button>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <span class="status-badge status-info text-normal me-2">{{ selected_content.state.replace('_', ' ').title()
                if selected_content.state else 'Draft' }}</span>
        </div>
        {% if selected and selected.human_edited %}
        <div class="alert alert-warning d-flex align-items-start gap-2">
            <i class="ti ti-info-circle mt-1"></i>
            <div>
                Manually edited by <strong>{{ selected.edited_by or 'Human Editor' }}</strong>
                {% if selected.edited_at %}
                    <span class="text-muted">on {{ selected.edited_at }}</span>
                {% endif %}
                {% if selected.edit_notes %}
                <div class="text-muted small mt-1">{{ selected.edit_notes }}</div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        <div class="content-body published-content" style="line-height: 1.8; font-size: 1rem;">
            {% if selected_content.body %}
            {{ selected_content.body | markdown }}
            {% else %}
            <p class="text-muted">No content available.</p>
            {% endif %}
        </div>

        {% if plan.target_channels %}
        <div class="mt-4">
            <h4 class="mb-2">Target Channels:</h4>
            <div class="d-flex flex-wrap gap-2">
                {% for channel in plan.target_channels %}
                <span class="status-badge status-neutral text-normal">
                    <i class="ti ti-brand-{{ channel.lower() }} me-1"></i>{{ channel }}
                </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if plan.seo_keywords %}
        <div class="mt-3">
            <h4 class="mb-2">SEO Keywords:</h4>
            <div class="d-flex flex-wrap gap-2">
                {% for keyword in plan.seo_keywords %}
                <span class="status-badge status-info text-normal">{{ keyword }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if selected and selected.issues %}
        <div class="mt-4">
            <h4 class="mb-2">Issues Detected</h4>
            <ul class="text-muted mb-0">
                {% for issue in selected.issues %}
                <li>{{ issue }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if selected and selected.recommendations %}
        <div class="mt-4">
            <h4 class="mb-2">Recommended Fixes</h4>
            <ul class="text-muted mb-0">
                {% for rec in selected.recommendations %}
                <li>{{ rec }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if selected and selected.strengths %}
        <div class="mt-4">
            <h4 class="mb-2">Strengths</h4>
            <ul class="text-muted mb-0">
                {% for strength in selected.strengths %}
                <li>{{ strength }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
</div>

{% set run_history = selected_run.refinement_history if selected_run and selected_run.refinement_history else
selected_run.refinement_history_snapshot if selected_run and selected_run.refinement_history_snapshot else
plan.refinement_history %}
{% if run_history and run_history|length > 0 %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="ti ti-history me-2"></i>
            Refinement History ({{ run_history|length }} iteration{{ 's' if run_history|length > 1 else '' }})
        </h3>
    </div>
    <div class="card-body">
        <div class="timeline">
            {% for iteration in run_history %}
            <div class="timeline-item">
                <div
                    class="timeline-badge status-{{ 'success' if iteration.get('score', 0) >= 95 else 'warning' if iteration.get('score', 0) >= 80 else 'danger' }}">
                    {{ iteration.get('iteration', loop.index) }}
                </div>
                <div class="timeline-content">
                    <div class="d-flex align-items-center mb-2">
                        <h4 class="mb-0">Iteration {{ iteration.get('iteration', loop.index) }}</h4>
                        <span
                            class="status-badge status-{{ 'success' if iteration.get('score', 0) >= 95 else 'warning' if iteration.get('score', 0) >= 80 else 'danger' }} ms-auto">
                            Score: {{ iteration.get('score', 0) }}
                        </span>
                    </div>
                    {% if iteration.get('issues') %}
                    <div class="text-muted mb-2">
                        <strong>Issues Found:</strong>
                        <ul class="mb-0">
                            {% for issue in iteration.get('issues', []) %}
                            <li>{{ issue }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% if iteration.get('refined_at') %}
                    <div class="text-muted small">
                        <i class="ti ti-clock me-1"></i>{{ iteration.get('refined_at') }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}
{% endif %}
