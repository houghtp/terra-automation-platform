{% if plan.skip_research %}
<!-- Skip Research Message -->
<div class="empty">
    <div class="empty-icon">
        <i class="ti ti-bolt icon-lg text-info"></i>
    </div>
    <p class="empty-title">Competitor research was skipped</p>
    <p class="empty-subtitle text-muted">
        This content was generated directly without competitor analysis for faster turnaround.
        The AI used the provided topic, description, and keywords to create the content.
    </p>
    <div class="empty-action">
                <span class="status-badge status-info">
            <i class="ti ti-bolt me-1"></i>Direct Generation Mode
        </span>
    </div>
</div>

{% elif not plan.research_data or not plan.research_data.get('seo_analysis') %}
<!-- No Research Data Available -->
<div class="empty">
    <div class="empty-icon">
        <i class="ti ti-search icon-lg text-muted"></i>
    </div>
    <p class="empty-title">No research data available</p>
    <p class="empty-subtitle text-muted">
        Research has not been performed yet. Generate content to see competitor analysis.
    </p>
</div>

{% else %}
<!-- Research Data Display -->
<div class="research-content">
    <!-- SEO Analysis Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">
                <i class="ti ti-chart-line me-2"></i>
                SEO Analysis & Insights
            </h3>
        </div>
        <div class="card-body">
            <div class="markdown-content" style="white-space: pre-wrap; line-height: 1.6;">{{ plan.research_data.get('seo_analysis', 'No analysis available') }}</div>
        </div>
    </div>

    <!-- Top Competitors Section -->
    {% if plan.research_data.get('top_results') %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">
                <i class="ti ti-trophy me-2"></i>
                Top Competing Content ({{ plan.research_data.get('top_results')|length }} sources analyzed)
            </h3>
        </div>
        <div class="card-body">
            <div class="row row-cards">
                {% for result in plan.research_data.get('top_results', []) %}
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex align-items-center">
                        <span class="status-badge status-info text-normal me-2">#{{ loop.index }}</span>
                                <h4 class="card-title mb-0">{{ result.get('title', 'Untitled') }}</h4>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-2">
                                <i class="ti ti-link me-1"></i>
                                <a href="{{ result.get('url', '#') }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                                    {{ result.get('url', 'No URL')[:50] }}{% if result.get('url', '')|length > 50 %}...{% endif %}
                                </a>
                            </p>

                            <!-- Scraped Content Accordion -->
                            {% if result.get('markdown') or result.get('scraped_content') %}
                            <div class="accordion mt-3" id="accordion-{{ loop.index }}">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading-{{ loop.index }}">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#collapse-{{ loop.index }}"
                                                aria-expanded="false"
                                                aria-controls="collapse-{{ loop.index }}">
                                            <i class="ti ti-file-text me-2"></i>
                                            View Scraped Content
                                        </button>
                                    </h2>
                                    <div id="collapse-{{ loop.index }}"
                                         class="accordion-collapse collapse"
                                         aria-labelledby="heading-{{ loop.index }}"
                                         data-bs-parent="#accordion-{{ loop.index }}">
                                        <div class="accordion-body">
                                            <div class="scraped-content" style="max-height: 400px; overflow-y: auto; font-size: 0.875rem; line-height: 1.5;">
                                                <pre class="m-0" style="white-space: pre-wrap; word-wrap: break-word;">{{ result.get('markdown') or result.get('scraped_content', 'No content available') }}</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Scraped Content Section (if stored separately) -->
    {% if plan.research_data.get('scraped_content') %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">
                <i class="ti ti-file-text me-2"></i>
                Scraped Competitor Content
            </h3>
        </div>
        <div class="card-body">
            {% for item in plan.research_data.get('scraped_content', []) %}
            <div class="mb-4">
                <div class="d-flex align-items-center mb-2">
                        <span class="status-badge status-info text-normal me-2">#{{ item.get('index', loop.index) }}</span>
                    <h4 class="mb-0">{{ item.get('title', 'Untitled') }}</h4>
                </div>
                <p class="text-muted small mb-2">
                    <i class="ti ti-link me-1"></i>
                    <a href="{{ item.get('url', '#') }}" target="_blank" rel="noopener noreferrer">{{ item.get('url', 'No URL') }}</a>
                </p>
                <div class="accordion" id="scraped-accordion-{{ loop.index }}">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="scraped-heading-{{ loop.index }}">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#scraped-collapse-{{ loop.index }}"
                                    aria-expanded="false">
                                View Content ({{ item.get('content_length', 0) }} characters)
                            </button>
                        </h2>
                        <div id="scraped-collapse-{{ loop.index }}" class="accordion-collapse collapse"
                             aria-labelledby="scraped-heading-{{ loop.index }}">
                            <div class="accordion-body">
                                <pre style="white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto;">{{ item.get('content', 'No content available') }}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% if not loop.last %}<hr>{% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Keywords Section -->
    {% if plan.research_data.get('keywords_found') %}
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="ti ti-tags me-2"></i>
                Extracted Keywords
            </h3>
        </div>
        <div class="card-body">
            <div class="d-flex flex-wrap gap-2">
                {% for keyword in plan.research_data.get('keywords_found', []) %}
                        <span class="status-badge status-neutral text-normal">{{ keyword }}</span>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<style>
.markdown-content {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.markdown-content h1, .markdown-content h2, .markdown-content h3 {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    font-weight: 600;
}

.markdown-content ul, .markdown-content ol {
    margin-left: 1.5rem;
    margin-bottom: 1rem;
}

.markdown-content p {
    margin-bottom: 1rem;
}

.scraped-content pre {
    font-size: 0.875rem;
    color: #333;
}
</style>
