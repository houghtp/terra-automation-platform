<div class="metadata-content">
    <!-- Plan Configuration -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">
                <i class="ti ti-settings me-2"></i>
                Plan Configuration
            </h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="text-muted small mb-1">Title</div>
                    <div><strong>{{ plan.title }}</strong></div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="text-muted small mb-1">Status</div>
                    <div>
                        <span class="badge bg-{{ 'success' if plan.status == 'draft_ready' else 'info' }}">
                            {{ plan.status.replace('_', ' ').title() }}
                        </span>
                    </div>
                </div>
                {% if plan.description %}
                <div class="col-12 mb-3">
                    <div class="text-muted small mb-1">Description</div>
                    <div>{{ plan.description }}</div>
                </div>
                {% endif %}
                <div class="col-md-6 mb-3">
                    <div class="text-muted small mb-1">Target Audience</div>
                    <div>{{ plan.target_audience or 'Not specified' }}</div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="text-muted small mb-1">Tone</div>
                    <div>{{ plan.tone.title() if plan.tone else 'Not specified' }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generation Parameters -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">
                <i class="ti ti-robot me-2"></i>
                AI Generation Parameters
            </h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="text-muted small mb-1">Research Mode</div>
                    <div>
                        {% if plan.skip_research %}
                        <span class="badge bg-info">
                            <i class="ti ti-bolt me-1"></i>Direct Generation
                        </span>
                        {% else %}
                        <span class="badge bg-primary">
                            <i class="ti ti-search me-1"></i>With Research
                        </span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="text-muted small mb-1">Min SEO Score Target</div>
                    <div><strong>{{ plan.min_seo_score }}</strong></div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="text-muted small mb-1">Max Iterations</div>
                    <div><strong>{{ plan.max_iterations }}</strong></div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="text-muted small mb-1">Current Iteration</div>
                    <div><strong>{{ plan.current_iteration }}</strong></div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="text-muted small mb-1">Latest SEO Score</div>
                    <div>
                        {% if plan.latest_seo_score %}
                        <span
                            class="badge bg-{{ 'success' if plan.latest_seo_score >= 95 else 'warning' if plan.latest_seo_score >= 80 else 'danger' }}">
                            {{ plan.latest_seo_score }}/100
                        </span>
                        {% else %}
                        <span class="text-muted">Not scored yet</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% set settings = plan.prompt_settings or {} %}
            <hr class="my-3">
            <h4 class="mb-3">Prompt Controls</h4>
            <div class="row">
                <div class="col-md-3 mb-2">
                    <div class="text-muted small">Professionalism</div>
                    <div><span class="badge bg-primary">{{ settings.get('professionalism_level', 4) }}/5</span></div>
                </div>
                <div class="col-md-3 mb-2">
                    <div class="text-muted small">Creativity</div>
                    <div><span class="badge bg-primary">{{ settings.get('creativity_level', 3) }}/5</span></div>
                </div>
                <div class="col-md-3 mb-2">
                    <div class="text-muted small">Humour</div>
                    <div><span class="badge bg-primary">{{ settings.get('humor_level', 1) }}/5</span></div>
                </div>
                <div class="col-md-3 mb-2">
                    <div class="text-muted small">SEO Strictness</div>
                    <div><span class="badge bg-primary">{{ settings.get('strictness_level', 4) }}/5</span></div>
                </div>
                <div class="col-md-3 mb-2">
                    <div class="text-muted small">Analysis Depth</div>
                    <div><span class="badge bg-primary">{{ settings.get('analysis_depth', 4) }}/5</span></div>
                </div>
            </div>

            {% if plan.generation_metadata %}
            <hr class="my-3">
            <h4 class="mb-3">Generation Metadata</h4>
            <div class="row">
                {% if plan.generation_metadata.get('model') %}
                <div class="col-md-4 mb-2">
                    <div class="text-muted small">AI Model</div>
                    <div><code>{{ plan.generation_metadata.get('model') }}</code></div>
                </div>
                {% endif %}
                {% if plan.generation_metadata.get('prompt_tokens') %}
                <div class="col-md-4 mb-2">
                    <div class="text-muted small">Prompt Tokens</div>
                    <div>{{ plan.generation_metadata.get('prompt_tokens') }}</div>
                </div>
                {% endif %}
                {% if plan.generation_metadata.get('completion_tokens') %}
                <div class="col-md-4 mb-2">
                    <div class="text-muted small">Completion Tokens</div>
                    <div>{{ plan.generation_metadata.get('completion_tokens') }}</div>
                </div>
                {% endif %}
                {% if plan.generation_metadata.get('cost_estimate') %}
                <div class="col-md-4 mb-2">
                    <div class="text-muted small">Estimated Cost</div>
                    <div>${{ "%.4f"|format(plan.generation_metadata.get('cost_estimate')) }}</div>
                </div>
                {% endif %}
                {% if plan.generation_metadata.get('generated_at') %}
                <div class="col-md-8 mb-2">
                    <div class="text-muted small">Generated At</div>
                    <div>{{ plan.generation_metadata.get('generated_at') }}</div>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Target Configuration -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">
                <i class="ti ti-target me-2"></i>
                Target Configuration
            </h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="text-muted small mb-2">Target Channels</div>
                    {% if plan.target_channels %}
                    <div class="d-flex flex-wrap gap-2">
                        {% for channel in plan.target_channels %}
                        <span class="badge bg-light text-dark">{{ channel }}</span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-muted">No channels specified</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <div class="text-muted small mb-2">SEO Keywords</div>
                    {% if plan.seo_keywords %}
                    <div class="d-flex flex-wrap gap-2">
                        {% for keyword in plan.seo_keywords %}
                        <span class="badge bg-light text-primary">{{ keyword }}</span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-muted">No keywords specified</div>
                    {% endif %}
                </div>
                {% if plan.competitor_urls %}
                <div class="col-12 mb-3">
                    <div class="text-muted small mb-2">Competitor URLs</div>
                    <ul class="mb-0">
                        {% for url in plan.competitor_urls %}
                        <li><a href="{{ url }}" target="_blank" rel="noopener noreferrer">{{ url }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Timeline -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">
                <i class="ti ti-calendar me-2"></i>
                Timeline
            </h3>
        </div>
        <div class="card-body">
            <div class="timeline">
                <div class="timeline-item">
                    <div class="timeline-badge bg-primary">
                        <i class="ti ti-plus"></i>
                    </div>
                    <div class="timeline-content">
                        <div><strong>Plan Created</strong></div>
                        <div class="text-muted small">
                            <i class="ti ti-clock me-1"></i>
                            {{ plan.created_at.strftime('%B %d, %Y at %I:%M %p') if plan.created_at else 'Unknown' }}
                        </div>
                        {% if plan.created_by %}
                        <div class="text-muted small">
                            <i class="ti ti-user me-1"></i>
                            By: {{ plan.created_by }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if plan.research_data and plan.research_data.get('research_completed_at') %}
                <div class="timeline-item">
                    <div class="timeline-badge bg-info">
                        <i class="ti ti-search"></i>
                    </div>
                    <div class="timeline-content">
                        <div><strong>Research Completed</strong></div>
                        <div class="text-muted small">
                            <i class="ti ti-clock me-1"></i>
                            {{ plan.research_data.get('research_completed_at') }}
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if content %}
                <div class="timeline-item">
                    <div class="timeline-badge bg-success">
                        <i class="ti ti-file-text"></i>
                    </div>
                    <div class="timeline-content">
                        <div><strong>Content Generated</strong></div>
                        <div class="text-muted small">
                            <i class="ti ti-clock me-1"></i>
                            {{ content.created_at.strftime('%B %d, %Y at %I:%M %p') if content.created_at else 'Unknown'
                            }}
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if plan.updated_at and plan.updated_at != plan.created_at %}
                <div class="timeline-item">
                    <div class="timeline-badge bg-warning">
                        <i class="ti ti-edit"></i>
                    </div>
                    <div class="timeline-content">
                        <div><strong>Last Updated</strong></div>
                        <div class="text-muted small">
                            <i class="ti ti-clock me-1"></i>
                            {{ plan.updated_at.strftime('%B %d, %Y at %I:%M %p') if plan.updated_at else 'Unknown' }}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- SEO Refinement Timeline -->
    {% if plan.refinement_history and plan.refinement_history|length > 0 %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">
                <i class="ti ti-chart-line me-2"></i>
                SEO Refinement Timeline
            </h3>
            <div class="card-subtitle text-muted mt-1">
                AI iteratively improved content quality from {{ plan.refinement_history[0].score }} to {{
                plan.latest_seo_score }} across {{ plan.refinement_history|length }} iteration{% if
                plan.refinement_history|length > 1 %}s{% endif %}
            </div>
        </div>
        <div class="card-body">
            <div class="refinement-timeline">
                {% for iteration in plan.refinement_history %}
                <div
                    class="refinement-step {% if iteration.score >= 95 %}success{% elif iteration.score >= 80 %}warning{% else %}danger{% endif %}">
                    <div class="refinement-badge">
                        <div class="iteration-number">{{ iteration.iteration }}</div>
                        {% if iteration.score >= 95 %}
                        <i class="ti ti-circle-check"></i>
                        {% elif iteration.score >= 80 %}
                        <i class="ti ti-alert-triangle"></i>
                        {% else %}
                        <i class="ti ti-alert-circle"></i>
                        {% endif %}
                    </div>
                    <div class="refinement-content">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h5 class="mb-1">Iteration {{ iteration.iteration }}</h5>
                                <div class="text-muted small">
                                    <i class="ti ti-clock me-1"></i>
                                    {{ iteration.timestamp[:19] if iteration.timestamp else 'Unknown time' }}
                                </div>
                            </div>
                            <div class="text-end">
                                <div
                                    class="seo-score {% if iteration.score >= 95 %}seo-excellent{% elif iteration.score >= 90 %}seo-good{% elif iteration.score >= 80 %}seo-fair{% elif iteration.score >= 70 %}seo-poor{% else %}seo-fail{% endif %}">
                                    <i
                                        class="ti {% if iteration.score >= 95 %}ti-circle-check{% else %}ti-alert-triangle{% endif %}"></i>
                                    {{ iteration.score }}
                                </div>
                                <div class="text-muted small mt-1">
                                    {{ iteration.status }}
                                </div>
                            </div>
                        </div>

                        {% if iteration.issues and iteration.issues|length > 0 %}
                        <div class="mt-2">
                            <strong class="text-danger">
                                <i class="ti ti-alert-circle me-1"></i>Issues Found:
                            </strong>
                            <ul class="small mb-2">
                                {% for issue in iteration.issues %}
                                <li>{{ issue }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        {% if iteration.recommendations and iteration.recommendations|length > 0 %}
                        <div class="mt-2">
                            <strong class="text-info">
                                <i class="ti ti-bulb me-1"></i>Recommendations:
                            </strong>
                            <ul class="small mb-0">
                                {% for rec in iteration.recommendations[:3] %}
                                <li>{{ rec }}</li>
                                {% endfor %}
                                {% if iteration.recommendations|length > 3 %}
                                <li class="text-muted">... and {{ iteration.recommendations|length - 3 }} more</li>
                                {% endif %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if plan.latest_seo_score >= plan.min_seo_score %}
            <div class="alert alert-success mt-3 mb-0">
                <i class="ti ti-circle-check me-2"></i>
                <strong>Target Achieved!</strong> Content reached the target SEO score of {{ plan.min_seo_score }}/100
                after {{ plan.refinement_history|length }} iteration{% if plan.refinement_history|length > 1 %}s{% endif
                %}.
            </div>
            {% else %}
            <div class="alert alert-warning mt-3 mb-0">
                <i class="ti ti-alert-triangle me-2"></i>
                <strong>Maximum Iterations Reached</strong> - Content achieved {{ plan.latest_seo_score }}/100 (target:
                {{ plan.min_seo_score }}/100)
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Technical Details -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="ti ti-code me-2"></i>
                Technical Details
            </h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-2">
                    <div class="text-muted small">Plan ID</div>
                    <div><code>{{ plan.id }}</code></div>
                </div>
                <div class="col-md-6 mb-2">
                    <div class="text-muted small">Tenant ID</div>
                    <div><code>{{ plan.tenant_id }}</code></div>
                </div>
                {% if content %}
                <div class="col-md-6 mb-2">
                    <div class="text-muted small">Generated Content ID</div>
                    <div><code>{{ content.id }}</code></div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .timeline {
        position: relative;
        padding-left: 3rem;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 2rem;
    }

    .timeline-item:last-child {
        padding-bottom: 0;
    }

    .timeline-badge {
        position: absolute;
        left: -3rem;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
    }

    .timeline-item:not(:last-child)::before {
        content: '';
        position: absolute;
        left: -2.25rem;
        top: 2.5rem;
        width: 2px;
        height: calc(100% - 2.5rem);
        background: #e9ecef;
    }

    .timeline-content {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 4px;
    }
</style>
