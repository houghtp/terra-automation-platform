/**
 * Content Table JavaScript
 * Consolidated implementation for Content Library table.
 * This file is the canonical content table used by the templates.
 */

// Helper formatters (used by planning-table.js and content table)
function formatState(cell) {
    const state = cell.getValue();
    const stateClasses = {
        'draft': 'bg-secondary',
        'in_review': 'bg-warning',
        'rejected': 'bg-danger',
        'scheduled': 'bg-info',
        'published': 'bg-success'
    };
    const className = stateClasses[state] || 'bg-secondary';
    const displayText = state ? state.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Draft';
    return `<span class="badge ${className}">${displayText}</span>`;
}

function formatApprovalStatus(cell) {
    const status = cell.getValue();
    const statusClasses = {
        'pending': 'bg-warning',
        'approved': 'bg-success',
        'rejected': 'bg-danger'
    };
    const className = statusClasses[status] || 'bg-secondary';
    const displayText = status ? status.charAt(0).toUpperCase() + status.slice(1) : 'Pending';
    return `<span class="badge ${className}">${displayText}</span>`;
}

function formatTags(cell) {
    const tags = cell.getValue() || [];
    if (tags.length === 0) return '<span class="text-muted">None</span>';
    return tags.slice(0, 3).map(tag =>
        `<span class="badge bg-light text-dark me-1">${tag}</span>`
    ).join('') + (tags.length > 3 ? ' <span class="text-muted">+' + (tags.length - 3) + '</span>' : '');
}

function formatDate(cell) {
    const date = cell.getValue();
    if (!date) return '<span class="text-muted">—</span>';
    return new Date(date).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

// Initialize Content Table (canonicalized from content-broadcaster-table.js)
window.initializeContentTable = function () {
    if (!window.appTables) {
        window.appTables = {};
    }

    const table = new Tabulator("#content-broadcaster-table", {
        ...advancedTableConfig,
        ajaxURL: "/features/content-broadcaster/api/list",
        // Support APIs that return either a raw array or a wrapped object like {data: [...], total: N}
        ajaxResponse: function (url, params, response) {
            if (Array.isArray(response)) return response;
            if (response && Array.isArray(response.data)) return response.data;
            if (response && Array.isArray(response.results)) return response.results;
            if (response && Array.isArray(response.items)) return response.items;
            if (response && Array.isArray(response.targets)) return response.targets;
            if (response && response.data && Array.isArray(response.data.data)) return response.data.data;
            if (response && typeof response === 'object') {
                for (const key in response) {
                    if (Array.isArray(response[key])) return response[key];
                }
            }
            return [];
        },
        // Support APIs that return either a raw array or a wrapped object like {data: [...], total: N}
        ajaxResponse: function (url, params, response) {
            // If the response is already an array, return it directly
            if (Array.isArray(response)) return response;

            // Common wrappers used across the codebase
            if (response && Array.isArray(response.data)) return response.data;
            if (response && Array.isArray(response.results)) return response.results;
            if (response && Array.isArray(response.items)) return response.items;
            if (response && Array.isArray(response.targets)) return response.targets;

            // If the response has a nested data/data structure (e.g., {data: {data: [...]}})
            if (response && response.data && Array.isArray(response.data.data)) return response.data.data;

            // Fallback: find the first array value in the object and return it
            if (response && typeof response === 'object') {
                for (const key in response) {
                    if (Array.isArray(response[key])) return response[key];
                }
            }

            // Nothing usable found - return empty array to avoid Tabulator error
            return [];
        },
        columns: [
            {
                title: "ID",
                field: "id",
                width: 80,
                sorter: "number",
                headerFilter: "number",
                headerFilterPlaceholder: "Filter by ID..."
            },
            {
                title: "Title",
                field: "title",
                minWidth: 200,
                headerFilter: "input",
                formatter: function (cell) {
                    return `<strong>${cell.getValue()}</strong>`;
                }
            },
            {
                title: "Content Type",
                field: "content_type",
                headerFilter: "list",
                headerFilterParams: {
                    values: {
                        "": "All Types",
                        "social_post": "Social Post",
                        "blog_article": "Blog Article",
                        "newsletter": "Newsletter",
                        "press_release": "Press Release"
                    }
                },
                sorter: "string",
                formatter: function (cell) {
                    const value = cell.getValue();
                    const badges = {
                        "social_post": '<span class="badge bg-primary">Social Post</span>',
                        "blog_article": '<span class="badge bg-info">Blog Article</span>',
                        "newsletter": '<span class="badge bg-warning">Newsletter</span>',
                        "press_release": '<span class="badge bg-success">Press Release</span>'
                    };
                    return badges[value] || `<span class="badge bg-secondary">${value}</span>`;
                },
                width: 150
            },
            {
                title: "State",
                field: "state",
                headerFilter: "list",
                headerFilterParams: {
                    values: {
                        "": "All States",
                        "draft": "Draft",
                        "pending_approval": "Pending Approval",
                        "approved": "Approved",
                        "scheduled": "Scheduled",
                        "published": "Published",
                        "archived": "Archived"
                    }
                },
                sorter: "string",
                formatter: function (cell) {
                    const value = cell.getValue();
                    const badges = {
                        "draft": '<span class="badge bg-secondary">Draft</span>',
                        "pending_approval": '<span class="badge bg-warning">Pending Approval</span>',
                        "approved": '<span class="badge bg-success">Approved</span>',
                        "scheduled": '<span class="badge bg-info">Scheduled</span>',
                        "published": '<span class="badge bg-primary">Published</span>',
                        "archived": '<span class="badge bg-dark">Archived</span>'
                    };
                    return badges[value] || `<span class="badge bg-light">${value}</span>`;
                },
                width: 140
            },
            {
                title: "Priority",
                field: "priority",
                headerFilter: "list",
                headerFilterParams: {
                    values: {
                        "": "All Priorities",
                        "low": "Low",
                        "normal": "Normal",
                        "high": "High",
                        "urgent": "Urgent"
                    }
                },
                sorter: "string",
                formatter: function (cell) {
                    const value = cell.getValue();
                    const badges = {
                        "low": '<span class="badge bg-success">Low</span>',
                        "normal": '<span class="badge bg-info">Normal</span>',
                        "high": '<span class="badge bg-warning">High</span>',
                        "urgent": '<span class="badge bg-danger">Urgent</span>'
                    };
                    return badges[value] || `<span class="badge bg-secondary">${value}</span>`;
                },
                width: 100
            },
            {
                title: "Channels",
                field: "target_channels",
                headerFilter: "input",
                headerFilterPlaceholder: "Search channels...",
                formatter: function (cell) {
                    const channels = cell.getValue();
                    if (!channels || channels.length === 0) {
                        return '<span class="text-muted">No channels</span>';
                    }
                    const channelBadges = channels.map(channel =>
                        `<span class="badge bg-light text-dark me-1">${channel}</span>`
                    ).join('');
                    return channelBadges;
                },
                width: 200
            },
            {
                title: "Scheduled Date",
                field: "scheduled_date",
                sorter: "datetime",
                formatter: function (cell) {
                    const value = cell.getValue();
                    if (!value) return '<span class="text-muted">Not scheduled</span>';
                    return new Date(value).toLocaleString();
                },
                width: 150
            },
            {
                title: "Created",
                field: "created_at",
                sorter: "datetime",
                formatter: function (cell) {
                    const value = cell.getValue();
                    return value ? new Date(value).toLocaleDateString() : '';
                },
                width: 100
            },
            {
                title: "Actions",
                field: "actions",
                formatter: function (cell) {
                    const rowData = cell.getRow().getData();
                    let actions = `
                        <i class="ti ti-eye row-action-icon" title="View Details" onclick="viewContentItem(${rowData.id})"></i>
                        <i class="ti ti-edit row-action-icon" title="Edit" onclick="editContentItem(${rowData.id})"></i>
                    `;

                    // Conditional actions based on state
                    if (rowData.state === 'pending_approval') {
                        actions += `<i class="ti ti-check row-action-icon text-success" title="Approve" onclick="approveContentItem(${rowData.id})"></i>`;
                        actions += `<i class="ti ti-x row-action-icon text-danger" title="Reject" onclick="rejectContentItem(${rowData.id})"></i>`;
                    }

                    if (rowData.state === 'approved') {
                        actions += `<i class="ti ti-calendar row-action-icon text-primary" title="Schedule" onclick="scheduleContentItem(${rowData.id})"></i>`;
                    }

                    actions += `<i class="ti ti-trash row-action-icon text-danger" title="Delete" onclick="deleteContentItem(${rowData.id})"></i>`;

                    return actions;
                },
                headerSort: false,
                width: 180
            }
        ]
    });

    // Store in global registry and keep the old variable name for compatibility
    window.contentTable = table;
    window.appTables["content-broadcaster-table"] = table;

    // Add cellEdited event listener
    addCellEditedHandler(table, '/features/content-broadcaster', 'Content Item');

    // Bulk Edit Selected
    addBulkEditHandler(table, '/features/content-broadcaster');

    // Bulk Delete Selected
    addBulkDeleteHandler(table, '/features/content-broadcaster', 'Content Item');

    // Row action handlers
    bindRowActionHandlers("#content-broadcaster-table", {
        onEdit: "editContentItem",
        onDelete: "deleteContentItem"
    });

    return table;
};

// Export table function
window.exportTable = function (format) {
    return exportTabulatorTable('content-broadcaster-table', format, 'content-items');
};

// Action handlers
window.viewContentItem = function (id) {
    fetch(`/features/content-broadcaster/api/${id}`)
        .then(response => response.json())
        .then(data => {
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <div class="modal-header">
                    <h5 class="modal-title">View Content Item: ${data.title}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Title:</strong> ${data.title}
                        </div>
                        <div class="col-md-6">
                            <strong>Type:</strong>
                            <span class="badge bg-primary">${data.content_type}</span>
                        </div>
                        <div class="col-md-6 mt-2">
                            <strong>State:</strong>
                            <span class="badge bg-info">${data.state}</span>
                        </div>
                        <div class="col-md-6 mt-2">
                            <strong>Priority:</strong>
                            <span class="badge bg-warning">${data.priority}</span>
                        </div>
                        <div class="col-12 mt-3">
                            <strong>Description:</strong>
                            <p class="mt-1">${data.description || 'No description provided'}</p>
                        </div>
                        <div class="col-12 mt-2">
                            <strong>Content:</strong>
                            <div class="bg-light p-3 rounded mt-1" style="max-height: 200px; overflow-y: auto;">
                                ${data.content || 'No content provided'}
                            </div>
                        </div>
                        <div class="col-md-6 mt-3">
                            <strong>Target Channels:</strong>
                            <div class="mt-1">
                                ${(data.target_channels || []).map(channel =>
                `<span class="badge bg-light text-dark me-1">${channel}</span>`
            ).join('')}
                            </div>
                        </div>
                        <div class="col-md-6 mt-3">
                            <strong>Scheduled Date:</strong>
                            <p class="mt-1">${data.scheduled_date ? new Date(data.scheduled_date).toLocaleString() : 'Not scheduled'}</p>
                        </div>
                        <div class="col-md-6 mt-2">
                            <strong>Created:</strong>
                            <p class="mt-1">${new Date(data.created_at).toLocaleString()}</p>
                        </div>
                        <div class="col-md-6 mt-2">
                            <strong>Updated:</strong>
                            <p class="mt-1">${data.updated_at ? new Date(data.updated_at).toLocaleString() : 'Never'}</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('modal')).show();
        })
        .catch(error => {
            console.error('Error loading content item:', error);
            showToast('Error loading content item details', 'error');
        });
};

// Edit content - load edit modal (URL remains the modal route)
window.editContent = function (contentId) {
    htmx.ajax('GET', `/features/content-broadcaster/${contentId}/edit`, {
        target: '#modal-body',
        swap: 'innerHTML'
    }).then(() => {
        const modal = new bootstrap.Modal(document.getElementById('modal'));
        modal.show();
    });
};

// Delete content - use standardized API delete endpoint
window.deleteContent = function (contentId) {
    showConfirmModal({
        title: 'Delete Content?',
        message: 'Are you sure you want to delete this content item? This action cannot be undone.',
        confirmText: 'Delete',
        confirmClass: 'btn-danger',
        onConfirm: function () {
            htmx.ajax('DELETE', `/features/content-broadcaster/api/${contentId}`, {
                swap: 'none'
            }).then(() => {
                if (window.contentTable) {
                    window.contentTable.setData();
                }
                showToast('Content deleted successfully', 'success');
            }).catch(() => {
                showToast('Failed to delete content', 'error');
            });
        }
    });
};

// Approve/Reject/Schedule actions (copied from broadcaster file)
window.approveContentItem = function (id) {
    fetch(`/features/content-broadcaster/approve/${id}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Content item approved successfully', 'success');
                if (window.contentTable) window.contentTable.replaceData();
            } else {
                showToast('Failed to approve content item', 'error');
            }
        })
        .catch(error => {
            console.error('Error approving content item:', error);
            showToast('Error approving content item', 'error');
        });
};

window.rejectContentItem = function (id) {
    const reason = prompt('Please provide a reason for rejection:');
    if (reason) {
        fetch(`/features/content-broadcaster/reject/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reason: reason })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Content item rejected', 'success');
                    if (window.contentTable) window.contentTable.replaceData();
                } else {
                    showToast('Failed to reject content item', 'error');
                }
            })
            .catch(error => {
                console.error('Error rejecting content item:', error);
                showToast('Error rejecting content item', 'error');
            });
    }
};

window.scheduleContentItem = function (id) {
    editTabulatorRow(`/features/content-broadcaster/${id}/schedule`);
};

// Listen for HX-Trigger events from the server
document.body.addEventListener('showSuccess', function () {
    showToast('✅ Operation completed successfully!', 'success');
});

document.body.addEventListener('refreshTable', function () {
    if (window.contentTable) {
        window.contentTable.setData();
    }
});

document.body.addEventListener('closeModal', function () {
    const modal = bootstrap.Modal.getInstance(document.getElementById('modal'));
    if (modal) {
        modal.hide();
    }
});

// Standard initialization pattern
document.addEventListener("DOMContentLoaded", () => {
    const tableElement = document.getElementById("content-broadcaster-table");
    if (tableElement && !window.contentTableInitialized) {
        window.contentTableInitialized = true;
        initializeContentTable();

        setTimeout(() => {
            initializeQuickSearch('table-quick-search', 'clear-search-btn', 'content-broadcaster-table');
        }, 100);
    }
});
/**
 * Content Table JavaScript
 * Consolidated implementation for Content Library table.
 * This file now contains the canonical content table used by the templates.
 */

// Helper formatters (used by planning-table.js and content table)
function formatState(cell) {
    const state = cell.getValue();
    const stateClasses = {
        'draft': 'bg-secondary',
        'in_review': 'bg-warning',
        'rejected': 'bg-danger',
        'scheduled': 'bg-info',
        'published': 'bg-success'
    };
    const className = stateClasses[state] || 'bg-secondary';
    const displayText = state ? state.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Draft';
    return `<span class="badge ${className}">${displayText}</span>`;
}

function formatApprovalStatus(cell) {
    const status = cell.getValue();
    const statusClasses = {
        'pending': 'bg-warning',
        'approved': 'bg-success',
        'rejected': 'bg-danger'
    };
    const className = statusClasses[status] || 'bg-secondary';
    const displayText = status ? status.charAt(0).toUpperCase() + status.slice(1) : 'Pending';
    return `<span class="badge ${className}">${displayText}</span>`;
}

function formatTags(cell) {
    const tags = cell.getValue() || [];
    if (tags.length === 0) return '<span class="text-muted">None</span>';
    return tags.slice(0, 3).map(tag =>
        `<span class="badge bg-light text-dark me-1">${tag}</span>`
    ).join('') + (tags.length > 3 ? ' <span class="text-muted">+' + (tags.length - 3) + '</span>' : '');
}

function formatDate(cell) {
    const date = cell.getValue();
    if (!date) return '<span class="text-muted">—</span>';
    return new Date(date).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

// Initialize Content Table (canonicalized from content-broadcaster-table.js)
window.initializeContentTable = function () {
    if (!window.appTables) {
        window.appTables = {};
    }

    const table = new Tabulator("#content-broadcaster-table", {
        ...advancedTableConfig,
        ajaxURL: "/features/content-broadcaster/api/list",
        columns: [
            {
                title: "ID",
                field: "id",
                width: 80,
                sorter: "number",
                headerFilter: "number",
                headerFilterPlaceholder: "Filter by ID..."
            },
            {
                title: "Title",
                field: "title",
                minWidth: 200,
                headerFilter: "input",
                formatter: function (cell) {
                    return `<strong>${cell.getValue()}</strong>`;
                }
            },
            {
                title: "Content Type",
                field: "content_type",
                headerFilter: "list",
                headerFilterParams: {
                    values: {
                        "": "All Types",
                        "social_post": "Social Post",
                        "blog_article": "Blog Article",
                        "newsletter": "Newsletter",
                        "press_release": "Press Release"
                    }
                },
                sorter: "string",
                formatter: function (cell) {
                    const value = cell.getValue();
                    const badges = {
                        "social_post": '<span class="badge bg-primary">Social Post</span>',
                        "blog_article": '<span class="badge bg-info">Blog Article</span>',
                        "newsletter": '<span class="badge bg-warning">Newsletter</span>',
                        "press_release": '<span class="badge bg-success">Press Release</span>'
                    };
                    return badges[value] || `<span class="badge bg-secondary">${value}</span>`;
                },
                width: 150
            },
            {
                title: "State",
                field: "state",
                headerFilter: "list",
                headerFilterParams: {
                    values: {
                        "": "All States",
                        "draft": "Draft",
                        "pending_approval": "Pending Approval",
                        "approved": "Approved",
                        "scheduled": "Scheduled",
                        "published": "Published",
                        "archived": "Archived"
                    }
                },
                sorter: "string",
                formatter: function (cell) {
                    const value = cell.getValue();
                    const badges = {
                        "draft": '<span class="badge bg-secondary">Draft</span>',
                        "pending_approval": '<span class="badge bg-warning">Pending Approval</span>',
                        "approved": '<span class="badge bg-success">Approved</span>',
                        "scheduled": '<span class="badge bg-info">Scheduled</span>',
                        "published": '<span class="badge bg-primary">Published</span>',
                        "archived": '<span class="badge bg-dark">Archived</span>'
                    };
                    return badges[value] || `<span class="badge bg-light">${value}</span>`;
                },
                width: 140
            },
            {
                title: "Priority",
                field: "priority",
                headerFilter: "list",
                headerFilterParams: {
                    values: {
                        "": "All Priorities",
                        "low": "Low",
                        "normal": "Normal",
                        "high": "High",
                        "urgent": "Urgent"
                    }
                },
                sorter: "string",
                formatter: function (cell) {
                    const value = cell.getValue();
                    const badges = {
                        "low": '<span class="badge bg-success">Low</span>',
                        "normal": '<span class="badge bg-info">Normal</span>',
                        "high": '<span class="badge bg-warning">High</span>',
                        "urgent": '<span class="badge bg-danger">Urgent</span>'
                    };
                    return badges[value] || `<span class="badge bg-secondary">${value}</span>`;
                },
                width: 100
            },
            {
                title: "Channels",
                field: "target_channels",
                headerFilter: "input",
                headerFilterPlaceholder: "Search channels...",
                formatter: function (cell) {
                    const channels = cell.getValue();
                    if (!channels || channels.length === 0) {
                        return '<span class="text-muted">No channels</span>';
                    }
                    const channelBadges = channels.map(channel =>
                        `<span class="badge bg-light text-dark me-1">${channel}</span>`
                    ).join('');
                    return channelBadges;
                },
                width: 200
            },
            {
                title: "Scheduled Date",
                field: "scheduled_date",
                sorter: "datetime",
                formatter: function (cell) {
                    const value = cell.getValue();
                    if (!value) return '<span class="text-muted">Not scheduled</span>';
                    return new Date(value).toLocaleString();
                },
                width: 150
            },
            {
                title: "Created",
                field: "created_at",
                sorter: "datetime",
                formatter: function (cell) {
                    const value = cell.getValue();
                    return value ? new Date(value).toLocaleDateString() : '';
                },
                width: 100
            },
            {
                title: "Actions",
                field: "actions",
                formatter: function (cell) {
                    const rowData = cell.getRow().getData();
                    let actions = `
                        <i class="ti ti-eye row-action-icon" title="View Details" onclick="viewContentItem(${rowData.id})"></i>
                        <i class="ti ti-edit row-action-icon" title="Edit" onclick="editContentItem(${rowData.id})"></i>
                    `;

                    // Conditional actions based on state
                    if (rowData.state === 'pending_approval') {
                        actions += `<i class="ti ti-check row-action-icon text-success" title="Approve" onclick="approveContentItem(${rowData.id})"></i>`;
                        actions += `<i class="ti ti-x row-action-icon text-danger" title="Reject" onclick="rejectContentItem(${rowData.id})"></i>`;
                    }

                    if (rowData.state === 'approved') {
                        actions += `<i class="ti ti-calendar row-action-icon text-primary" title="Schedule" onclick="scheduleContentItem(${rowData.id})"></i>`;
                    }

                    actions += `<i class="ti ti-trash row-action-icon text-danger" title="Delete" onclick="deleteContentItem(${rowData.id})"></i>`;

                    return actions;
                },
                headerSort: false,
                width: 180
            }
        ]
    });

    // Store in global registry and keep the old variable name for compatibility
    window.contentTable = table;
    window.appTables["content-broadcaster-table"] = table;

    // Add cellEdited event listener
    addCellEditedHandler(table, '/features/content-broadcaster', 'Content Item');

    // Bulk Edit Selected
    addBulkEditHandler(table, '/features/content-broadcaster');

    // Bulk Delete Selected
    addBulkDeleteHandler(table, '/features/content-broadcaster', 'Content Item');

    // Row action handlers
    bindRowActionHandlers("#content-broadcaster-table", {
        onEdit: "editContentItem",
        onDelete: "deleteContentItem"
    });

    return table;
};

// Export table function
window.exportTable = function (format) {
    return exportTabulatorTable('content-broadcaster-table', format, 'content-items');
};

// Action handlers
window.viewContentItem = function (id) {
    fetch(`/features/content-broadcaster/api/${id}`)
        .then(response => response.json())
        .then(data => {
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <div class="modal-header">
                    <h5 class="modal-title">View Content Item: ${data.title}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Title:</strong> ${data.title}
                        </div>
                        <div class="col-md-6">
                            <strong>Type:</strong>
                            <span class="badge bg-primary">${data.content_type}</span>
                        </div>
                        <div class="col-md-6 mt-2">
                            <strong>State:</strong>
                            <span class="badge bg-info">${data.state}</span>
                        </div>
                        <div class="col-md-6 mt-2">
                            <strong>Priority:</strong>
                            <span class="badge bg-warning">${data.priority}</span>
                        </div>
                        <div class="col-12 mt-3">
                            <strong>Description:</strong>
                            <p class="mt-1">${data.description || 'No description provided'}</p>
                        </div>
                        <div class="col-12 mt-2">
                            <strong>Content:</strong>
                            <div class="bg-light p-3 rounded mt-1" style="max-height: 200px; overflow-y: auto;">
                                ${data.content || 'No content provided'}
                            </div>
                        </div>
                        <div class="col-md-6 mt-3">
                            <strong>Target Channels:</strong>
                            <div class="mt-1">
                                ${(data.target_channels || []).map(channel =>
                `<span class="badge bg-light text-dark me-1">${channel}</span>`
            ).join('')}
                            </div>
                        </div>
                        <div class="col-md-6 mt-3">
                            <strong>Scheduled Date:</strong>
                            <p class="mt-1">${data.scheduled_date ? new Date(data.scheduled_date).toLocaleString() : 'Not scheduled'}</p>
                        </div>
                        <div class="col-md-6 mt-2">
                            <strong>Created:</strong>
                            <p class="mt-1">${new Date(data.created_at).toLocaleString()}</p>
                        </div>
                        <div class="col-md-6 mt-2">
                            <strong>Updated:</strong>
                            <p class="mt-1">${data.updated_at ? new Date(data.updated_at).toLocaleString() : 'Never'}</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('modal')).show();
        })
        .catch(error => {
            console.error('Error loading content item:', error);
            showToast('Error loading content item details', 'error');
        });
};

// Edit content - load edit modal (URL remains the modal route)
window.editContent = function (contentId) {
    htmx.ajax('GET', `/features/content-broadcaster/${contentId}/edit`, {
        target: '#modal-body',
        swap: 'innerHTML'
    }).then(() => {
        const modal = new bootstrap.Modal(document.getElementById('modal'));
        modal.show();
    });
};

// Delete content - use standardized API delete endpoint
window.deleteContent = function (contentId) {
    showConfirmModal({
        title: 'Delete Content?',
        message: 'Are you sure you want to delete this content item? This action cannot be undone.',
        confirmText: 'Delete',
        confirmClass: 'btn-danger',
        onConfirm: function () {
            htmx.ajax('DELETE', `/features/content-broadcaster/api/${contentId}`, {
                swap: 'none'
            }).then(() => {
                if (window.contentTable) {
                    window.contentTable.setData();
                }
                showToast('Content deleted successfully', 'success');
            }).catch(() => {
                showToast('Failed to delete content', 'error');
            });
        }
    });
};

// Approve/Reject/Schedule actions (copied from broadcaster file)
window.approveContentItem = function (id) {
    fetch(`/features/content-broadcaster/approve/${id}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Content item approved successfully', 'success');
                if (window.contentTable) window.contentTable.replaceData();
            } else {
                showToast('Failed to approve content item', 'error');
            }
        })
        .catch(error => {
            console.error('Error approving content item:', error);
            showToast('Error approving content item', 'error');
        });
};

window.rejectContentItem = function (id) {
    const reason = prompt('Please provide a reason for rejection:');
    if (reason) {
        fetch(`/features/content-broadcaster/reject/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reason: reason })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Content item rejected', 'success');
                    if (window.contentTable) window.contentTable.replaceData();
                } else {
                    showToast('Failed to reject content item', 'error');
                }
            })
            .catch(error => {
                console.error('Error rejecting content item:', error);
                showToast('Error rejecting content item', 'error');
            });
    }
};

window.scheduleContentItem = function (id) {
    editTabulatorRow(`/features/content-broadcaster/${id}/schedule`);
};

// Listen for HX-Trigger events from the server
document.body.addEventListener('showSuccess', function () {
    showToast('✅ Operation completed successfully!', 'success');
});

document.body.addEventListener('refreshTable', function () {
    if (window.contentTable) {
        window.contentTable.setData();
    }
});

document.body.addEventListener('closeModal', function () {
    const modal = bootstrap.Modal.getInstance(document.getElementById('modal'));
    if (modal) {
        modal.hide();
    }
});

// Standard initialization pattern
document.addEventListener("DOMContentLoaded", () => {
    const tableElement = document.getElementById("content-broadcaster-table");
    if (tableElement && !window.contentTableInitialized) {
        window.contentTableInitialized = true;
        initializeContentTable();

        setTimeout(() => {
            initializeQuickSearch('table-quick-search', 'clear-search-btn', 'content-broadcaster-table');
        }, 100);
    }
});

// === QUICK FIX: Standardized CRUD Functions (added to fix edit/delete) ===
// These override any duplicate/incorrect definitions above

// Delete content item - use standardized deleteTabulatorRow utility
window.deleteContentItem = function (contentId) {
    deleteTabulatorRow(
        `/features/content-broadcaster/api/${contentId}`,
        '#content-broadcaster-table',
        {
            title: 'Delete Content',
            message: 'Are you sure you want to delete this content item? This action cannot be undone.',
            confirmText: 'Delete'
        }
    );
};

// Edit content item - use standardized editTabulatorRow utility
window.editContentItem = function (contentId) {
    editTabulatorRow(`/features/content-broadcaster/${contentId}/edit`);
};
