<div class="d-flex flex-column h-100">
  {% if thread_id %}
    <div class="d-flex align-items-center justify-content-between py-3 px-4 border-bottom">
      <div>
        <div class="fw-semibold">{{ participants_label or 'Conversation' }}</div>
        <div class="text-muted small">{{ participants_secondary }}</div>
      </div>
      <button
        class="btn btn-outline-secondary btn-sm"
        hx-get="/features/community/messages/threads/{{ thread_id }}"
        hx-target="#thread-pane"
        hx-swap="innerHTML"
        hx-trigger="click"
      >
        <i class="ti ti-refresh"></i>
      </button>
    </div>
  {% endif %}

  <div id="messages-list" class="flex-grow-1 overflow-auto px-4 py-3" style="background: #f8fafc;">
    {% if messages %}
      {% for msg in messages %}
        {% set is_sender = (msg.sender_id == current_member_id) %}
        <div class="d-flex mb-2 {% if is_sender %}justify-content-end{% else %}justify-content-start{% endif %}">
          <div class="px-3 py-2 rounded-3 shadow-sm {% if is_sender %}bg-primary text-white{% else %}bg-white border{% endif %}" style="max-width: 80%;">
            <div class="small fw-semibold mb-1">{{ "You" if is_sender else (other_party_name or msg.sender_id) }}</div>
            <div class="mb-1">{{ msg.content }}</div>
            <div class="small {% if is_sender %}text-white-75{% else %}text-muted{% endif %}">
              {{ msg.created_at.strftime("%b %d %H:%M") if msg.created_at else "" }}
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="text-muted text-center py-4">No messages yet. Start the conversation below.</div>
    {% endif %}
  </div>

  <form
    class="border-top p-3"
    {% if thread_id %}
      hx-post="/features/community/messages/threads/{{ thread_id }}/reply"
    {% else %}
      hx-post="/features/community/messages/partials/new"
    {% endif %}
    hx-target="#thread-pane"
    hx-swap="innerHTML"
    hx-disabled-elt="fieldset"
  >
    <fieldset class="form-fieldset mb-0">
      {% if thread_id %}
        <input type="hidden" name="recipient_id" value="{{ other_party or '' }}">
      {% else %}
        <div class="mb-2">
          <label class="form-label">To</label>
          <input
            type="hidden"
            name="recipient_id"
            id="new_recipient_id"
            value="{{ recipient_id or '' }}"
          >
          <input
            type="text"
            name="recipient_label"
            id="new_recipient_label"
            value="{{ recipient_label or '' }}"
            class="form-control"
            placeholder="Type a name or email"
            hx-get="/features/community/messages/partials/recipients"
            hx-trigger="input changed delay:400ms, keyup[key=='Enter']"
            hx-target="#new-recipient-results"
            hx-swap="innerHTML"
            autocomplete="off"
          >
          <div id="new-recipient-results"></div>
        </div>
      {% endif %}
      <div class="mb-2">
        <textarea name="content" class="form-control" rows="3" placeholder="Message..." required></textarea>
        {% if errors and errors.get("content") %}
          <div class="invalid-feedback d-block">{{ errors["content"][0] }}</div>
        {% endif %}
      </div>
      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">
          <span class="htmx-indicator spinner-border spinner-border-sm me-2" role="status"></span>
          Send
        </button>
      </div>
    </fieldset>
  </form>
</div>
