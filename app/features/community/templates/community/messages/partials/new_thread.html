{% set recip = recipient_label if recipient_label is defined else "" %}
<div class="d-flex flex-column h-100">
  <div class="py-3 px-4 border-bottom">
    <div class="fw-semibold">New Conversation</div>
    <div class="text-muted small">Pick a recipient and start chatting.</div>
  </div>
  <div class="flex-grow-1 d-flex flex-column justify-content-between">
    <div class="p-4 text-muted">
      Start a new thread by choosing a recipient and writing your first message.
    </div>
    <form
      class="border-top p-3"
      hx-post="/features/community/messages/partials/new"
      hx-target="#thread-pane"
      hx-swap="innerHTML"
      hx-disabled-elt="fieldset"
    >
      <fieldset class="form-fieldset mb-0">
        <div class="mb-3">
          <label class="form-label">To</label>
          {% set selected_ids = recipient_ids if recipient_ids is defined else [] %}
          {% include "community/messages/partials/recipient_picker.html" with context %}
          {% if errors and errors.get("recipient_ids") %}
            <div class="invalid-feedback d-block">{{ errors["recipient_ids"][0] }}</div>
          {% endif %}
        </div>
        <div class="mb-2">
          <textarea name="content" class="form-control" rows="3" placeholder="Message..." required>{{ content if content is defined else "" }}</textarea>
          {% if errors and errors.get("content") %}
            <div class="invalid-feedback d-block">{{ errors["content"][0] }}</div>
          {% endif %}
          {% if errors and errors.get("recipient_id") %}
            <div class="invalid-feedback d-block">{{ errors["recipient_id"][0] }}</div>
          {% endif %}
          {% if errors and errors.get("general") %}
            <div class="invalid-feedback d-block">{{ errors["general"][0] }}</div>
          {% endif %}
        </div>
        <div class="d-flex justify-content-end">
          <button type="submit" class="btn btn-primary">
            <span class="htmx-indicator spinner-border spinner-border-sm me-2" role="status"></span>
            Send
          </button>
        </div>
      </fieldset>
    </form>
  </div>
</div>
