{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Analytics Dashboard{% endblock %}

{% block head %}
    <!-- Chart Widget CSS -->
    <link href="/static/css/chart-widgets.css" rel="stylesheet">

    <!-- Chart Widget Web Component -->
    <script src="/dashboard/static/js/chart-widget.js"></script>
    <!-- Stats Card Web Component -->
    <script src="/dashboard/static/js/stats-card.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Dashboard Header -->

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-sm-6 col-lg-3">
            <stats-card
                id="total-items-card"
                title="Total Items"
                value="{{ summary.total_items or 0 }}"
                description="Total demo items in system"
                icon="ti ti-database"
                color="green"
                data-url="/dashboard/api/summary"
                data-key="total_items"
                auto-refresh="300000">
            </stats-card>
        </div>

        <div class="col-sm-6 col-lg-3">
            <stats-card
                id="active-items-card"
                title="Active Items"
                value="{{ summary.active_items or 0 }}"
                description="Items with active status"
                icon="ti ti-check-circle"
                color="blue"
                data-url="/dashboard/api/summary"
                data-key="active_items"
                auto-refresh="300000">
            </stats-card>
        </div>

        <div class="col-sm-6 col-lg-3">
            <stats-card
                id="enabled-items-card"
                title="Enabled Items"
                value="{{ summary.enabled_items or 0 }}"
                description="Currently enabled items"
                icon="ti ti-toggle-right"
                color="primary"
                data-url="/dashboard/api/summary"
                data-key="enabled_items"
                auto-refresh="300000">
            </stats-card>
        </div>

        <div class="col-sm-6 col-lg-3">
            <stats-card
                id="completion-rate-card"
                title="Completion Rate"
                value="{{ summary.completion_rate or 0 }}%"
                description="Active vs total items"
                icon="ti ti-percentage"
                color="orange"
                data-url="/dashboard/api/summary"
                data-key="completion_rate"
                auto-refresh="300000">
            </stats-card>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="dashboard-grid">
        <!-- Status Breakdown Bar Chart -->
                    <chart-widget
                        id="status-chart"
                        type="bar"
                        title="Status Breakdown"
                        data-url="/dashboard/api/status-breakdown"
                        description="Distribution of items by status"
                        class="chart-widget">
                    </chart-widget>        <!-- Enabled/Disabled Donut Chart -->
                    <chart-widget
                        id="enabled-chart"
                        type="pie"
                        title="Enabled Status"
                        data-url="/dashboard/api/enabled-breakdown"
                        description="Distribution of enabled vs disabled items"
                        class="chart-widget">
                    </chart-widget>        <!-- Items Over Time Line Chart -->
                    <chart-widget
                        id="timeline-chart"
                        type="line"
                        title="Items Timeline"
                        data-url="/dashboard/api/items-timeline"
                        description="Timeline of item creation over time"
                        class="chart-widget">
                    </chart-widget>
                </div>
                <div class="col-md-6">
                <chart-widget
                    id="tags-chart"
                    type="donut"
                    title="Tags Distribution"
                    data-url="/dashboard/api/tags-distribution"
                    description="Most common tags used in items"
                    class="chart-widget">
                </chart-widget>
    </div>

    <!-- Action Items Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="ti ti-list-check me-2"></i>
                        Quick Actions
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <h5>Data Management</h5>
                                <ul class="list-unstyled space-y-2">
                                    <li>
                                        <a href="/business-automations/demo/items" class="text-decoration-none">
                                            <i class="ti ti-table me-2"></i>Manage Demo Items
                                        </a>
                                    </li>
                                    <li>
                                        <a href="/business-automations/demo/items/partials/form" class="text-decoration-none"
                                           hx-get="/business-automations/demo/items/partials/form" hx-target="#modal-body" hx-swap="innerHTML">
                                            <i class="ti ti-plus me-2"></i>Add New Item
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#" class="text-decoration-none" onclick="refreshAllCharts()">
                                            <i class="ti ti-refresh me-2"></i>Refresh All Charts
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="mb-3">
                                <h5>Analytics</h5>
                                <ul class="list-unstyled space-y-2">
                                    <li>
                                        <a href="#" class="text-decoration-none" onclick="exportAllCharts()">
                                            <i class="ti ti-download me-2"></i>Export Charts
                                        </a>
                                    </li>
                                    <li>
                                        <a href="/business-automations/demo/items?view=analytics" class="text-decoration-none">
                                            <i class="ti ti-chart-bar me-2"></i>Detailed Analytics
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#" class="text-decoration-none" onclick="showFullscreenChart()">
                                            <i class="ti ti-maximize me-2"></i>Fullscreen View
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="mb-3">
                                <h5>System</h5>
                                <ul class="list-unstyled space-y-2">
                                    <li>
                                        <a href="/docs" class="text-decoration-none">
                                            <i class="ti ti-book me-2"></i>API Documentation
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#" class="text-decoration-none" onclick="checkSystemHealth()">
                                            <i class="ti ti-heart me-2"></i>System Health
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#" class="text-decoration-none" onclick="showDataSources()">
                                            <i class="ti ti-database me-2"></i>Data Sources
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dashboard utility functions
function refreshAllCharts() {
    // Refresh stats cards first
    if (window.StatsCardUtils) {
        StatsCardUtils.refreshAll();
    }

    // Then refresh charts
    const charts = document.querySelectorAll('chart-widget');
    charts.forEach(chart => {
        const refreshBtn = chart.querySelector('.chart-refresh');
        if (refreshBtn) {
            refreshBtn.click();
        }
    });

    // Show toast notification
    if (window.showToast) {
        showToast('Refreshing all charts and stats...', 'info', 2000);
    }
}

function exportAllCharts() {
    const charts = document.querySelectorAll('chart-widget');
    charts.forEach((chart, index) => {
        setTimeout(() => {
            const exportBtn = chart.querySelector('.chart-export[data-format="png"]');
            if (exportBtn) {
                exportBtn.click();
            }
        }, index * 500); // Stagger exports
    });

    if (window.showToast) {
        showToast('Exporting all charts...', 'info', 3000);
    }
}

function showFullscreenChart() {
    const firstChart = document.querySelector('chart-widget');
    if (firstChart) {
        const fullscreenBtn = firstChart.querySelector('.chart-fullscreen');
        if (fullscreenBtn) {
            fullscreenBtn.click();
        }
    }
}

function checkSystemHealth() {
    fetch('/dashboard/api/summary')
        .then(response => response.json())
        .then(data => {
            if (window.showToast) {
                showToast(`System Health: ${data.total_items} items processed successfully`, 'success');
            }
        })
        .catch(error => {
            if (window.showToast) {
                showToast('System health check failed', 'error');
            }
        });
}

function showDataSources() {
    if (window.showToast) {
        showToast('Data sources: Demo Items table, Real-time processing', 'info', 4000);
    }
}

// Auto-refresh charts every 5 minutes
setInterval(refreshAllCharts, 300000);

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard initialized with chart widgets');

    // Add loading state management
    const charts = document.querySelectorAll('chart-widget');
    charts.forEach(chart => {
        chart.addEventListener('load', function() {
            console.log('Chart loaded:', this.getAttribute('title'));
        });
    });
});
</script>
{% endblock %}
