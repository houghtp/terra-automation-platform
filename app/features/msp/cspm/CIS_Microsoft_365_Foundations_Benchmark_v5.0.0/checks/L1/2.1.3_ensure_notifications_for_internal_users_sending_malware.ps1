# Control: 2.1.3 - Ensure notifications for internal users sending malware
<# CIS_METADATA_START
{"Description": "Exchange Online Protection (EOP) is Microsoft's cloud-based filtering service that\nprotects organizations against spam, malware, and other email threats. EOP is included\nin all Microsoft 365 organizations with Exchange Online mailboxes.\nEOP uses flexible anti-malware policies for malware protection settings. These policies\ncan be set to notify Admins of malicious activity.", "Impact": "Notification of account with potential issues should not have an impact on the user.", "Audit": "To audit using the UI:\n1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n2. Click to expand E-mail & Collaboration select Policies & rules.\n3. On the Policies & rules page select Threat policies.\n4. Under Policies select Anti-malware.\n5. Click on the Default (Default) policy.\n6. Ensure the setting Notify an admin about undelivered messages from\ninternal senders is set to On and that there is at least one email address\nunder Administrator email address.\nTo audit using PowerShell:\n1. Connect to Exchange Online using Connect-ExchangeOnline.\n2. Run the following command:\nGet-MalwareFilterPolicy | fl Identity,\nEnableInternalSenderAdminNotifications, InternalSenderAdminAddress\nNote: Audit and Remediation guidance may focus on the Default policy however, if a\nCustom Policy exists in the organization's tenant, then ensure the setting is set as\noutlined in the highest priority policy listed.", "Remediation": "To remediate using the UI:\n1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n2. Click to expand E-mail & Collaboration select Policies & rules.\n3. On the Policies & rules page select Threat policies.\n4. Under Policies select Anti-malware.\n5. Click on the Default (Default) policy.\n6. Click on Edit protection settings and change the settings for Notify an\nadmin about undelivered messages from internal senders to On and\nenter the email address of the administrator who should be notified under\nAdministrator email address.\n7. Click Save.\nTo remediate using PowerShell:\n1. Connect to Exchange Online using Connect-ExchangeOnline.\n2. Run the following command:\nSet-MalwareFilterPolicy -Identity '{Identity Name}' -\nEnableInternalSenderAdminNotifications $True -InternalSenderAdminAddress\n{admin@domain1.com}\nNote: Audit and Remediation guidance may focus on the Default policy however, if a\nCustom Policy exists in the organization's tenant, then ensure the setting is set as\noutlined in the highest priority policy listed.", "Title": "Ensure notifications for internal users sending malware is Enabled", "ProfileApplicability": "- E3 Level 1\n- E5 Level 1", "SubSection": "2.1 Email & collaboration", "DefaultValue": "EnableInternalSenderAdminNotifications : False\nInternalSenderAdminAddress : $null", "Level": "L1", "CISControls": "[{\"version\": \"\", \"id\": \"17.5\", \"title\": \"Assign Key Roles and Responsibilities\", \"description\": \"Assign key roles and responsibilities for incident response, including staff from legal, IT, information security, facilities, public relations, human resources, incident - - responders, and analysts, as applicable. Review annually, or when significant enterprise changes occur that could impact this Safeguard.\", \"ig1\": false, \"ig2\": false, \"ig3\": false}, {\"version\": \"v8\", \"id\": \"7.1\", \"title\": \"Ensure Use of Only Fully Supported Browsers and\", \"description\": \"Email Clients Ensure that only fully supported web browsers and email clients are allowed to - - - execute in the organization, ideally only using the latest version of the browsers and email clients provided by the vendor.\", \"ig1\": false, \"ig2\": false, \"ig3\": false}, {\"version\": \"v7\", \"id\": \"8.1\", \"title\": \"Utilize Centrally Managed Anti-malware Software\", \"description\": \"Utilize centrally managed anti-malware software to continuously monitor and - - defend each of the organization's workstations and servers.\", \"ig1\": false, \"ig2\": false, \"ig3\": false}]", "References": "1. https://learn.microsoft.com/en-us/defender-office-365/anti-malware-protection-\nabout\n2. https://learn.microsoft.com/en-us/defender-office-365/anti-malware-policies-\nconfigure", "Rationale": "This setting alerts administrators that an internal user sent a message that contained\nmalware. This may indicate an account or machine compromise that would need to be\ninvestigated.", "Section": "2 Microsoft 365 Defender", "RecommendationId": "2.1.3"}
CIS_METADATA_END #>
# Required Services: ExchangeOnline
# Note: Authentication is handled centrally - do not add Connect-* commands

$ErrorActionPreference = 'Stop'

try {
    # Initialize results array
    $resourceResults = @()
    # Retrieve malware filter policies
    $malwareFilterPolicies = Get-MalwareFilterPolicy | Select-Object Identity, EnableInternalSenderAdminNotifications, InternalSenderAdminAddress
    
    # Process each policy and determine compliance
    foreach ($policy in $malwareFilterPolicies) {
        $isCompliant = $policy.EnableInternalSenderAdminNotifications -eq $true -and $policy.InternalSenderAdminAddress -ne $null
        
        $resourceResults += @{
            Identity = $policy.Identity
            EnableInternalSenderAdminNotifications = $policy.EnableInternalSenderAdminNotifications
            InternalSenderAdminAddress = $policy.InternalSenderAdminAddress
            IsCompliant = $isCompliant
        }
    }
    
    # Determine overall status
    $overallStatus = if (($resourceResults | Where-Object { -not $_.IsCompliant })) { 'Fail' } else { 'Pass' }
    $status_id = if ($overallStatus -eq 'Pass') { 1 } else { 3 }
    
    return @{
        status = $overallStatus
        status_id = $status_id
        Details = $resourceResults
    }
}
catch {
    Write-Error "Script execution failed: $($_.Exception.Message)"
    return @{
        status = "Error"
        status_id = 3
        Details = @()
        Error = $_.Exception.Message
    }
}
