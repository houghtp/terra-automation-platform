# Control: 2.1.10 - Ensure DMARC Records for all Exchange Online
<# CIS_METADATA_START
{"Description":"DMARC, or Domain-based Message Authentication, Reporting, and Conformance,\nassists recipient mail systems in determining the appropriate action to take when\nmessages from a domain fail to meet SPF or DKIM authentication criteria.","Impact":"There should be no impact of setting up DMARC however, organizations should ensure\nappropriate setup to ensure continuous mail-flow.","Audit":"To audit using PowerShell:\n1. Open a command prompt.\n2. For each of the Accepted Domains in Exchange Online run the following in\nPowerShell:\nResolve-DnsName _dmarc.[domain1.com] txt\n3. Ensure that the record exists and has at minimum the following flags defined as\nfollows:\nv=DMARC1; (p=quarantine OR p=reject), pct=100, rua=mailto:<reporting\nemail address> and ruf=mailto:<reporting email address>\nThe below example records would pass as they contain a policy that would either\nquarantine or reject messages failing DMARC, the policy affects 100% of mail\npct=100 as well as containing valid reporting addresses:\nv=DMARC1; p=reject; pct=100; rua=mailto:rua@contoso.com;\nruf=mailto:ruf@contoso.com; fo=1\nv=DMARC1; p=reject; pct=100; fo=1; ri=3600; rua=mailto:rua@contoso.com;\nruf=mailto:ruf@contoso.com\nv=DMARC1; p=quarantine; pct=100; sp=none; fo=1; ri=3600;\nrua=mailto:rua@contoso.com; ruf=ruf@contoso.com;\n4. Ensure the Microsoft MOERA domain is also configured.\nResolve-DnsName _dmarc.[tenant].onmicrosoft.com txt\n5. Ensure the record meets the same criteria listed in step #3.\nNote: Resolve-DnsName is not available on older versions of Windows prior to\nWindows 8 and Server 2012.","Remediation":"To remediate using a DNS Provider:\n1. For each Exchange Online Accepted Domain, add the following record to DNS:\nRecord: _dmarc.domain1.com\nType: TXT\nValue: v=DMARC1; p=none; rua=mailto:<rua-report@example.com>;\nruf=mailto:<ruf-report@example.com>\n2. This will create a basic DMARC policy that will allow the organization to start\nmonitoring message statistics.\n3. One week is enough time for data generated by the reports to be useful in\nunderstanding email trends and traffic. The final step requires implementing a\npolicy of p=reject OR p=quarantine and pct=100 with the necessary rua and\nruf email addresses defined:\nRecord: _dmarc.domain1.com\nType: TXT\nValue: v=DMARC1; p=reject; pct=100; rua=mailto:<rua-report@example.com>;\nruf=mailto:<ruf-report@example.com>\nAlso remediate the MOREA domain using the UI:\n1. Navigate to the Microsoft 365 admin center https://admin.microsoft.com/\n2. Expand Settings and select Domains.\n3. Select your tenant domain (for example, contoso.onmicrosoft.com).\n4. Select DNS records and click + Add record.\n5. Add a new record with the TXT name of _dmarc with the appropriate values\noutlined above.\nNote: The remediation portion involves a multi-staged approach over a period of time.\nFirst, a baseline of the current state of email will be established with p=none and rua\nand ruf. Once the environment is better understood and reports have been analyzed\nan organization will move to the final state with dmarc record values as outlined in the\naudit section.\nMicrosoft has a list of best practices for implementing DMARC that cover these steps in\ndetail.","Title":"Ensure DMARC Records for all Exchange Online","ProfileApplicability":"- E3 Level 1\n- E5 Level 1","SubSection":"2.1 Email & collaboration","DefaultValue":"","Level":"L1","CISControls":"[{\"version\": \"\", \"id\": \"9.5\", \"title\": \"Implement DMARC\", \"description\": \"v8 To lower the chance of spoofed or modified emails from valid domains, - - implement DMARC policy and verification, starting with implementing the Sender Policy Framework (SPF) and the DomainKeys Identified Mail (DKIM) standards.\", \"ig1\": false, \"ig2\": false, \"ig3\": false}, {\"version\": \"\", \"id\": \"7.8\", \"title\": \"Implement DMARC and Enable Receiver-Side\", \"description\": \"Verification v7 To lower the chance of spoofed or modified emails from valid domains, - - implement Domain-based Message Authentication, Reporting and Conformance (DMARC) policy and verification, starting by implementing the Sender Policy Framework (SPF) and the DomainKeys Identified Mail(DKIM) standards.\", \"ig1\": false, \"ig2\": false, \"ig3\": false}]","References":"1. https://learn.microsoft.com/en-us/defender-office-365/email-authentication-\ndmarc-configure?view=o365-worldwide\n2. https://learn.microsoft.com/en-us/defender-office-365/step-by-step-guides/how-\nto-enable-dmarc-reporting-for-microsoft-online-email-routing-address-moera-and-\nparked-domains?view=o365-worldwide\n3. https://media.defense.gov/2024/May/02/2003455483/-1/-1/0/CSA-NORTH-\nKOREAN-ACTORS-EXPLOIT-WEAK-DMARC.PDF","Rationale":"DMARC strengthens the trustworthiness of messages sent from an organization's\ndomain to destination email systems. By integrating DMARC with SPF (Sender Policy\nFramework) and DKIM (DomainKeys Identified Mail), organizations can significantly\nenhance their defenses against email spoofing and phishing attempts.\nLeaving a DMARC policy set to p=none can result in failed action when a spear phishing\nemail fails DMARC but passes SPF and DKIM checks. Having DMARC fully configured\nis a critical part in preventing business email compromise.","Section":"2 Microsoft 365 Defender","RecommendationId":"2.1.10"}
CIS_METADATA_END #>
# Required Services: ExchangeOnline
# Note: Authentication is handled centrally - do not add Connect-* commands

$ErrorActionPreference = 'Stop'

try {
    # Initialize results array
    $resourceResults = @()
    
    # Retrieve all accepted domains in Exchange Online
    $acceptedDomains = Get-AcceptedDomain

    foreach ($domain in $acceptedDomains) {
        # Construct the DMARC DNS record name
        $dmarcRecordName = "_dmarc.$($domain.DomainName)"
        
        try {
            # Resolve the DMARC DNS record
            $dmarcRecord = Resolve-DnsName -Name $dmarcRecordName -Type TXT
            
            # Extract the TXT record value
            $dmarcValue = ($dmarcRecord | Where-Object { $_.QueryType -eq 'TXT' }).Strings -join "; "
            
            # Check compliance based on the required DMARC policy
            $isCompliant = $dmarcValue -match "v=DMARC1;.*(p=quarantine|p=reject);.*pct=100;.*rua=mailto:.*;.*ruf=mailto:.*;"
        }
        catch {
            # If DNS resolution fails, mark as non-compliant
            $dmarcValue = "No DMARC record found"
            $isCompliant = $false
        }
        
        # Add the result for the current domain
        $resourceResults += @{
            ResourceName = $domain.DomainName
            CurrentValue = $dmarcValue
            IsCompliant = $isCompliant
        }
    }
    
    # Determine overall status
    $overallStatus = if (($resourceResults | Where-Object { -not $_.IsCompliant })) { 'Fail' } else { 'Pass' }
    $status_id = if ($overallStatus -eq 'Pass') { 1 } else { 3 }
    
    return @{
        status = $overallStatus
        status_id = $status_id
        Details = $resourceResults
    }
}
catch {
    Write-Error "Script execution failed: $($_.Exception.Message)"
    return @{
        status = "Error"
        status_id = 3
        Details = @()
        Error = $_.Exception.Message
    }
}
