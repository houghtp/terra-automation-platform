<div class="modal-header">
  <h5 class="modal-title">
    <i class="ti ti-list-check me-2"></i>
    {% if assignment %}Edit Benchmark Assignment{% else %}Add Benchmark Assignment{% endif %}
  </h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form
  hx-post="{% if assignment %}/msp/cspm/tenant-benchmarks/{{ assignment.id }}{% else %}/msp/cspm/tenant-benchmarks{% endif %}"
  hx-target="#tenant-benchmarks-area"
  hx-swap="innerHTML"
  class="needs-validation"
  novalidate>

  <div class="modal-body">
    {% if form_error %}
    <div class="alert alert-danger">
      <i class="ti ti-alert-circle me-2"></i>{{ form_error }}
    </div>
    {% endif %}

    {% if is_global_admin %}
    <div class="row mb-3">
      <div class="col-12">
        <label class="form-label required">Assign to Platform Tenant</label>
        <select
          class="form-select"
          name="target_tenant_id"
          {% if assignment %}disabled{% endif %}
          required>
          <option value="" {% if not assignment and not (form_data and form_data.target_tenant_id) %}selected{% endif %}>Select a tenant</option>
          {% for option in available_tenants %}
          <option value="{{ option.id }}"
            {% if (form_data and form_data.target_tenant_id == option.id) or (assignment and assignment.tenant_id == option.id and not form_data) %}selected{% endif %}>
            {{ option.name }}
          </option>
          {% endfor %}
        </select>
        <div class="form-text">
          Choose which platform tenant will receive this benchmark assignment.
        </div>
        {% if assignment %}
        <input type="hidden" name="target_tenant_id" value="{{ assignment.tenant_id }}">
        {% endif %}
      </div>
    </div>
    {% else %}
      <input type="hidden" name="target_tenant_id" value="{{ (form_data.target_tenant_id if form_data and form_data.target_tenant_id else (assignment.tenant_id if assignment else current_tenant_id)) }}">
    {% endif %}

    <div class="row mb-3">
      <div class="col-12">
        <label class="form-label required">Benchmark</label>
        <select
          class="form-select"
          name="benchmark_id"
          {% if assignment %}disabled{% endif %}
          required>
          <option value="" {% if not assignment and not (form_data and form_data.benchmark_id) %}selected{% endif %}>
            Select benchmark...
          </option>
          {% for benchmark in available_benchmarks %}
          <option value="{{ benchmark.id }}"
            {% if (assignment and assignment.benchmark_id == benchmark.id) or (form_data and form_data.benchmark_id == benchmark.id) %}selected{% endif %}>
            {{ benchmark.display_name }} ({{ benchmark.tech_type }})
          </option>
          {% endfor %}
        </select>
        <div class="form-text">
          Select the CIS benchmark to enable for this tenant.
        </div>
        {% if assignment %}
        <input type="hidden" name="benchmark_id" value="{{ assignment.benchmark_id }}">
        {% endif %}
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-12">
        <label class="form-label">Display Name</label>
        <input
          type="text"
          class="form-control"
          name="display_name"
          maxlength="255"
          value="{% if form_data and form_data.display_name is not none %}{{ form_data.display_name }}{% elif assignment %}{{ assignment.display_name }}{% else %}{% endif %}"
          placeholder="e.g. Contoso M365 Benchmark">
        <div class="form-text">
          Optional: Customize how this assignment appears in tables and forms.
        </div>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-12">
        <label class="form-label">Status</label>
        <select class="form-select" name="status">
          {% set current_status = (form_data.status if form_data and form_data.status is not none else (assignment.status if assignment else 'active')) %}
          <option value="active" {% if current_status == 'active' %}selected{% endif %}>Active</option>
          <option value="inactive" {% if current_status == 'inactive' %}selected{% endif %}>Inactive</option>
        </select>
        <div class="form-text">
          Inactive assignments remain in history but are hidden from default scans.
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <label class="form-label">Technology Configuration (JSON)</label>
        <textarea
          class="form-control font-monospace"
          name="config_json"
          rows="6"
          placeholder="{&#10;  &quot;key&quot;: &quot;value&quot;&#10;}">{{ form_data.config_json if form_data and form_data.config_json is not none else config_text }}</textarea>
        <div class="form-text">
          Optional advanced configuration passed to the scanner (per benchmark requirements).
        </div>
      </div>
    </div>

    {% if assignment and assignment.benchmark %}
    <div class="alert alert-info mt-4">
      <i class="ti ti-info-circle me-2"></i>
      <strong>{{ assignment.benchmark.display_name }}</strong> &middot; {{ assignment.benchmark.tech_type }}
      <div class="small text-muted mt-1">
        Benchmark key: {{ assignment.benchmark.benchmark_key }}
        {% if assignment.benchmark.description %}
        <br>{{ assignment.benchmark.description }}
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
      <i class="ti ti-x me-2"></i>Cancel
    </button>
    <button type="submit" class="btn btn-outline-primary">
      <i class="ti ti-device-floppy me-2"></i>{% if assignment %}Save Changes{% else %}Create Assignment{% endif %}
    </button>
  </div>
</form>

<script>
  (function () {
    'use strict';
    const form = document.querySelector('#modal-body form');
    if (!form) {
      return;
    }

    form.addEventListener('submit', function (event) {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    });
  })();
</script>
