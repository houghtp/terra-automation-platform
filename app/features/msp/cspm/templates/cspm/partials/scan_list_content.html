{% set description = "Track Microsoft 365 compliance scan runs and monitor progress." %}
{% set title = "Compliance Scans" %}
{% set icon = "ti ti-shield-check" %}
{% set add_url = "/msp/cspm/partials/scan-form" %}
{% set entity_name = "Compliance Scan" %}
{% set table_id = "cspm-scans-table" %}
{% set id_prefix = "cspm-scans" %}
{% set show_bulk_actions = False %}
{% set add_label = "Start Scan" %}

<!-- Analytics Row -->
<div class="row mb-3">
  <!-- Overview Stats -->
  <div class="col-md-3">
    <div class="card" id="scans-overview-stats">
      <div class="card-body">
        <h3 class="card-title mb-3">Overview</h3>
        <div class="d-flex flex-column gap-2">
          <div class="d-flex justify-content-between">
            <span class="text-muted">Total Scans:</span>
            <strong id="total-scans-stat">-</strong>
          </div>
          <div class="d-flex justify-content-between">
            <span class="text-muted">Completed:</span>
            <strong class="text-success" id="completed-scans-stat">-</strong>
          </div>
          <div class="d-flex justify-content-between">
            <span class="text-muted">Failed:</span>
            <strong class="text-danger" id="failed-scans-stat">-</strong>
          </div>
          <div class="d-flex justify-content-between">
            <span class="text-muted">Running:</span>
            <strong class="text-info" id="running-scans-stat">-</strong>
          </div>
          <hr class="my-2">
          <div class="d-flex justify-content-between">
            <span class="text-muted">Avg Pass Rate:</span>
            <strong class="text-primary" id="avg-pass-rate-stat">-</strong>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Compliance Trend -->
  <div class="col-md-6">
    <chart-widget
      id="compliance-trend-chart"
      title="Compliance Over Time"
      type="line"
      data-url="/msp/cspm/analytics/compliance-trend"
      height="180px"
      loading-text="Loading trend data..."
      x-field="date"
      y-field="pass_rate"
      y-label="Pass Rate (%)"
      show-legend="false">
    </chart-widget>
  </div>

  <!-- Status Distribution -->
  <div class="col-md-3">
    <chart-widget
      id="status-distribution-chart"
      title="Scan Status"
      type="donut"
      data-url="/msp/cspm/analytics/status-distribution"
      height="180px"
      loading-text="Loading status data..."
      colors='{"completed": "#28a745", "failed": "#dc3545", "running": "#17a2b8", "pending": "#6c757d", "cancelled": "#ffc107"}'>
    </chart-widget>
  </div>
</div>

<!-- Scans Table -->
<div class="card">
  <div class="card-header">
    {% include "components/ui/table_actions.html" with context %}
  </div>
  <div class="card-body p-0">
    <div id="cspm-scans-table" class="tabulator-container"></div>
  </div>
</div>

<div class="alert alert-info mt-3" role="alert">
  <i class="ti ti-info-circle me-2"></i>
  View detailed results for any run via the row actions. Running scans update automatically as progress events arrive.
</div>
