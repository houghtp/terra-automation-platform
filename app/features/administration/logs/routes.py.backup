"""
Log management routes for viewing and filtering application logs by tenant.
"""
from datetime import datetime
from typing import Optional
from fastapi import APIRouter, Request, Depends, Query, HTTPException
from fastapi.responses import HTMLResponse, JSONResponse
from sqlalchemy.ext.asyncio import AsyncSession

from app.features.core.database import get_db
from app.features.core.templates import templates
from app.features.core.rate_limiter import rate_limit_api
from .models import ApplicationLog
from .services import LogService
from app.features.auth.dependencies import get_current_user
from app.features.auth.models import User
from app.deps.tenant import tenant_dependency
import structlog

logger = structlog.get_logger(__name__)
router = APIRouter(tags=["logs"])


async def get_log_service(
    db: AsyncSession = Depends(get_db),
    tenant_id: str = Depends(tenant_dependency)
) -> LogService:
    """Dependency to get log service."""
    return LogService(db, tenant_id)


@router.get("/", response_class=HTMLResponse, name="logs_dashboard")
async def logs_dashboard(
    request: Request,
    tenant_id: str = Depends(tenant_dependency),
    current_user: User = Depends(get_current_user),
    log_service: LogService = Depends(get_log_service)
):
    """Display log management dashboard."""
    try:
        return templates.TemplateResponse(
            "administration/logs/logs_dashboard.html",
            {
                "request": request,
                "user": current_user,
                "page_title": "Application Logs",
                "page_description": "View and filter application logs by tenant"
            }
        )
    except Exception as e:
        logger.exception("Failed to render logs dashboard")
        raise HTTPException(status_code=500, detail="Failed to load logs dashboard")


@router.get("/api/list", name="logs_list_api")
async def get_logs_list(
    request: Request,
    tenant_id: str = Depends(tenant_dependency),
    current_user: User = Depends(get_current_user),
    page: int = Query(1, ge=1),
    size: int = Query(25, ge=1, le=200),
    level: Optional[str] = Query(None, description="Filter by log level"),
    logger_name: Optional[str] = Query(None, description="Filter by logger name"),
    start_date: Optional[str] = Query(None, description="Start date (ISO format)"),
    end_date: Optional[str] = Query(None, description="End date (ISO format)"),
    sort: Optional[str] = Query("timestamp"),
    order: Optional[str] = Query("desc"),
    log_service: LogService = Depends(get_log_service),
    _rate_limit: dict = Depends(rate_limit_api)
):
    """API endpoint for Tabulator table data."""
    try:
        offset = (page - 1) * size

        # Parse dates if provided
        start_dt = None
        end_dt = None

        if start_date:
            try:
                start_dt = datetime.fromisoformat(start_date.replace('Z', '+00:00'))
            except ValueError:
                raise HTTPException(status_code=400, detail="Invalid start_date format")

        if end_date:
            try:
                end_dt = datetime.fromisoformat(end_date.replace('Z', '+00:00'))
            except ValueError:
                raise HTTPException(status_code=400, detail="Invalid end_date format")

        result = await log_service.get_logs_list(
            level=level,
            logger_name=logger_name,
            start_date=start_dt,
            end_date=end_dt,
            limit=size,
            offset=offset
        )

        # Convert to dictionaries
        logs_data = [log.to_dict() for log in result["data"]]

        return JSONResponse(content={
            "items": logs_data,
            "total": result["total"],
            "page": page,
            "size": size
        })

    except HTTPException:
        raise
    except Exception as e:
        logger.exception("Failed to get logs list via API")
        raise HTTPException(status_code=500, detail="Failed to retrieve logs")

@router.get("/api/summary", name="logs_summary_api")
async def get_logs_summary(
    request: Request,
    hours: int = Query(24, ge=1, le=168, description="Hours to look back"),
    tenant_id: str = Depends(tenant_dependency),
    current_user: User = Depends(get_current_user),
    log_service: LogService = Depends(get_log_service),
    _rate_limit: dict = Depends(rate_limit_api)
):
    """Get log summary statistics."""
    try:
        return await log_service.get_logs_summary(
            hours=hours
        )

    except Exception as e:
        logger.exception("Failed to get logs summary")
        raise HTTPException(status_code=500, detail="Failed to retrieve log summary")


@router.get("/api/stats", name="logs_stats_api")
async def get_logs_stats(
    request: Request,
    tenant_id: str = Depends(tenant_dependency),
    current_user: User = Depends(get_current_user),
    log_service: LogService = Depends(get_log_service),
    _rate_limit: dict = Depends(rate_limit_api)
):
    """Get log statistics (alias for summary to match audit pattern)."""
    try:
        return await log_service.get_logs_summary(hours=24)

    except Exception as e:
        logger.exception("Failed to get logs stats")
        raise HTTPException(status_code=500, detail="Failed to retrieve log statistics")


@router.get("/api/tenants", response_class=JSONResponse, name="logs_tenants_api")
async def get_tenant_list(
    request: Request,
    tenant_id: str = Depends(tenant_dependency),
    current_user: User = Depends(get_current_user),
    log_service: LogService = Depends(get_log_service),
    _rate_limit: dict = Depends(rate_limit_api)
):
    """Get list of all tenants that have logs."""
    try:
        tenants = await log_service.get_tenant_list()
        return {"tenants": tenants}

    except Exception as e:
        logger.exception("Failed to get tenant list")
        raise HTTPException(status_code=500, detail="Failed to retrieve tenant list")


@router.get("/api/{log_id}", response_class=JSONResponse, name="logs_detail_api")
async def get_log_details(
    log_id: int,
    request: Request,
    tenant_id: str = Depends(tenant_dependency),
    current_user: User = Depends(get_current_user),
    log_service: LogService = Depends(get_log_service)
):
    """Get detailed information for a specific log entry."""
    try:
        log_entry = await log_service.get_log_by_id(log_id)

        if not log_entry:
            raise HTTPException(status_code=404, detail="Log entry not found")

        return log_entry.to_dict()

    except HTTPException:
        raise
    except Exception as e:
        logger.exception(f"Failed to get log details for {log_id}")
        raise HTTPException(status_code=500, detail="Failed to retrieve log details")


@router.delete("/api/cleanup", response_class=JSONResponse, name="logs_cleanup_api")
async def cleanup_old_logs(
    request: Request,
    days: int = Query(30, ge=1, le=365, description="Delete logs older than this many days"),
    tenant_id: str = Depends(tenant_dependency),
    current_user: User = Depends(get_current_user),
    log_service: LogService = Depends(get_log_service),
    _rate_limit: dict = Depends(rate_limit_api)
):
    """Clean up old log entries to manage database size."""
    try:
        return await log_service.cleanup_old_logs(days=days)

    except Exception as e:
        logger.exception("Failed to cleanup old logs")
        raise HTTPException(status_code=500, detail="Failed to cleanup logs")
