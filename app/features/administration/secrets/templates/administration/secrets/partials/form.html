<div class="modal-header">
  <h5 class="modal-title">{{ 'Edit' if secret else 'Create' }} Secret</h5>
</div>

<form
  id="secret-form"
  {% if not secret %}
  hx-post="/features/administration/secrets/"
  {% else %}
  hx-put="/features/administration/secrets/{{ secret.id }}"
  {% endif %}
  hx-disabled-elt="button[type='submit']"
  hx-indicator="#submit-spinner"
  autocomplete="off"
>
  <div class="modal-body">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Secret Name *</label>
        <input
          name="name"
          value="{{ form_data.name if form_data else (secret.name if secret else '') }}"
          required
          class="form-control {{ 'is-invalid' if errors and 'name' in errors else '' }}"
          placeholder="e.g., OpenAI API Key"
          maxlength="255"
          hx-post="/features/administration/secrets/validate/name"
          hx-trigger="blur changed delay:500ms"
          hx-target="#name-validation"
          hx-include="[name='name'], [name='secret_id']"
        />
        {% if secret %}
        <input type="hidden" name="secret_id" value="{{ secret.id }}" />
        {% endif %}
        <div id="name-validation">
          {% if errors and 'name' in errors %}
            <span class="invalid-feedback d-block">{{ errors.name[0] }}</span>
          {% endif %}
        </div>
        <small class="form-hint">A descriptive name to identify this secret.</small>
      </div>

      {# Tenant selection for global admins #}
      {% if is_global_admin %}
      <div class="col-md-6">
        <label class="form-label">{{ 'Current Tenant' if secret else 'Target Tenant' }} *</label>
        <select
          name="target_tenant_id"
          required
          class="form-select {{ 'is-invalid' if errors and 'target_tenant_id' in errors else '' }}"
        >
          <option value="">Select a tenant...</option>
          {% for tenant in available_tenants %}
          <option value="{{ tenant.id }}" {{ 'selected' if (form_data and form_data.target_tenant_id == tenant.id) or (secret and secret.tenant_id == tenant.id|string) else '' }}>
            {{ tenant.name }}
          </option>
          {% endfor %}
        </select>
        {% if errors and 'target_tenant_id' in errors %}
          <div class="invalid-feedback">{{ errors.target_tenant_id[0] }}</div>
        {% endif %}
        <div class="form-text">
          {{ 'Change which tenant this secret belongs to.' if secret else 'Select which tenant this secret will belong to.' }}
        </div>
      </div>
      {% endif %}

      <div class="col-md-6">
        <label class="form-label">Secret Type</label>
        <select name="secret_type" class="form-control" required>
          {% for type_value in secret_types %}
          <option value="{{ type_value }}"
                  {{ 'selected' if secret and secret.secret_type == type_value else '' }}>
            {{ type_value.replace('_', ' ').title() }}
          </option>
          {% endfor %}
        </select>
        <small class="form-hint">Categorize the type of secret for better organization.</small>
      </div>

      <div class="col-12">
        <label class="form-label">Description</label>
        <textarea
          name="description"
          rows="2"
          class="form-control {{ 'is-invalid' if errors and 'description' in errors else '' }}"
          placeholder="Optional description of what this secret is used for..."
          maxlength="1000"
          hx-post="/features/administration/secrets/validate/description"
          hx-trigger="blur changed delay:500ms"
          hx-target="#description-validation"
          hx-include="[name='description']"
        >{{ form_data.description if form_data else (secret.description if secret else '') }}</textarea>
        <div id="description-validation">
          {% if errors and 'description' in errors %}
            <span class="invalid-feedback d-block">{{ errors.description[0] }}</span>
          {% endif %}
        </div>
        <small class="form-hint">Optional description to help identify the purpose of this secret.</small>
      </div>

      <div class="col-12">
        <label class="form-label">Secret Value *</label>
        <div class="input-group">
          <textarea
            name="value"
            rows="3"
            class="form-control {{ 'is-invalid' if errors and 'value' in errors else '' }}"
            placeholder="Enter the secret value (API key, token, password, etc.)"
            {{ 'required' if not secret else '' }}
            style="font-family: monospace;"
            hx-post="/features/administration/secrets/validate/value"
            hx-trigger="blur changed delay:500ms"
            hx-target="#value-validation"
            hx-include="[name='value']"
          ></textarea>
        </div>
        <div id="value-validation">
          {% if errors and 'value' in errors %}
            <span class="invalid-feedback d-block">{{ errors.value[0] }}</span>
          {% endif %}
        </div>
        <small class="form-hint">
          {% if secret %}
          Leave empty to keep the current value. Enter a new value to update.
          {% else %}
          The secret value will be encrypted and stored securely.
          {% endif %}
        </small>
      </div>

      <!-- Advanced Options Accordion -->
      <div class="col-12">
        <div class="accordion" id="advancedOptions">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button"
                      data-bs-toggle="collapse" data-bs-target="#collapseAdvanced"
                      aria-expanded="false">
                Advanced Options
              </button>
            </h2>
            <div id="collapseAdvanced" class="accordion-collapse collapse">
              <div class="accordion-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Expiration Date</label>
                    <input
                      name="expires_at"
                      type="datetime-local"
                      class="form-control"
                      value="{{ secret.expires_at.strftime('%Y-%m-%dT%H:%M') if secret and secret.expires_at else '' }}"
                    />
                    <small class="form-hint">Optional: Set when this secret should expire.</small>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Auto-rotation Interval (days)</label>
                    <input
                      name="rotation_interval_days"
                      type="number"
                      class="form-control {{ 'is-invalid' if errors and 'rotation_interval_days' in errors else '' }}"
                      value="{{ secret.rotation_interval_days if secret else '' }}"
                      min="1"
                      max="365"
                      placeholder="e.g., 90"
                      hx-post="/features/administration/secrets/validate/rotation-interval"
                      hx-trigger="blur changed delay:500ms"
                      hx-target="#rotation-interval-validation"
                      hx-include="[name='rotation_interval_days']"
                    />
                    <div id="rotation-interval-validation">
                      {% if errors and 'rotation_interval_days' in errors %}
                        <span class="invalid-feedback d-block">{{ errors.rotation_interval_days[0] }}</span>
                      {% endif %}
                    </div>
                    <small class="form-hint">Optional: Automatically remind to rotate this secret every X days.</small>
                  </div>

                  {% if secret %}
                  <div class="col-12">
                    <label class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        name="is_active"
                        value="true"
                        {{ 'checked' if secret.is_active else '' }}
                      />
                      <span class="form-check-label">Active</span>
                    </label>
                    <small class="form-hint">Inactive secrets are hidden from normal operations but preserved for audit.</small>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
      <i class="ti ti-x icon"></i>
      Cancel
    </button>
    <button type="submit" class="btn btn-outline-primary">
      <i class="ti ti-check icon"></i>
      <span id="submit-spinner" class="htmx-indicator spinner-border spinner-border-sm me-2" role="status"></span>
      {{ 'Update' if secret else 'Create' }}
    </button>
  </div>
</form>
